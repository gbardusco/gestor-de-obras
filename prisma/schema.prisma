// ProMeasure Pro - Enterprise SaaS Schema
// PostgreSQL + Prisma ORM
// Versão: 1.0.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// 1. MULTI-TENANCY & AUTHENTICATION
// ============================================================================

enum PlanTier {
  FREE       // Limite: 3 projetos, 2 usuários
  PRO        // Limite: 50 projetos, 10 usuários
  ENTERPRISE // Ilimitado
}

enum UserRole {
  SUPERADMIN // Acesso total ao sistema (Anthropic internal)
  ADMIN      // Administrador da organização
  MANAGER    // Gerente de projetos (pode criar obras e atribuir engenheiros)
  ENGINEER   // Engenheiro de campo (acesso apenas às obras atribuídas)
  VIEWER     // Visualização read-only
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique // URL-safe identifier (ex: "construtora-abc")
  planTier  PlanTier @default(FREE)
  
  // Billing
  stripeCustomerId       String?  @unique
  stripeSubscriptionId   String?  @unique
  subscriptionStatus     String?  // active, canceled, past_due
  trialEndsAt            DateTime?
  
  // Limits (enforced in app layer)
  projectLimit    Int      @default(3)    // FREE: 3, PRO: 50, ENTERPRISE: -1 (unlimited)
  userLimit       Int      @default(2)    // FREE: 2, PRO: 10, ENTERPRISE: -1
  storageLimit    BigInt   @default(104857600) // 100MB in bytes (FREE), PRO: 10GB, ENTERPRISE: unlimited
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // Soft delete
  
  // Relations
  users            User[]
  projects         Project[]
  projectGroups    ProjectGroup[]
  globalSettings   GlobalSettings?
  auditLogs        AuditLog[]
  biddingProcesses BiddingProcess[]
  
  @@index([slug])
  @@index([planTier])
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String   // bcrypt hash
  role         UserRole @default(VIEWER)
  
  // Profile
  avatarUrl    String?
  phoneNumber  String?
  position     String?  // Cargo (ex: "Engenheiro Civil", "Orçamentista")
  
  // Security
  emailVerified    Boolean   @default(false)
  lastLoginAt      DateTime?
  passwordResetToken String?
  passwordResetExpires DateTime?
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  
  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  projectMemberships ProjectMember[]
  createdProjects    Project[]       @relation("ProjectCreator")
  auditLogs          AuditLog[]
  journalEntries     JournalEntry[]
  
  @@index([organizationId])
  @@index([email])
}

// ============================================================================
// 2. PROJECT STRUCTURE & ACCESS CONTROL
// ============================================================================

enum AccessLevel {
  READ       // Apenas visualização
  WRITE      // Edição de medições e lançamentos
  ADMIN      // Controle total (configurações, exclusão)
}

model ProjectMember {
  id          String      @id @default(cuid())
  accessLevel AccessLevel @default(READ)
  
  // Relations
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, projectId]) // Um usuário não pode ter múltiplos acessos ao mesmo projeto
  @@index([projectId])
  @@index([userId])
}

model ProjectGroup {
  id       String  @id @default(cuid())
  name     String
  parentId String? // Auto-relacionamento para hierarquia de pastas
  order    Int     @default(0)
  
  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  parent   ProjectGroup?  @relation("GroupHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children ProjectGroup[] @relation("GroupHierarchy")
  projects Project[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([organizationId])
  @@index([parentId])
}

enum ProjectStatus {
  PLANNING     // Planejamento inicial
  ACTIVE       // Em execução
  PAUSED       // Paralisada
  COMPLETED    // Concluída
  CANCELED     // Cancelada
}

model Project {
  id          String        @id @default(cuid())
  name        String
  companyName String        // Cliente/Contratante
  location    String
  status      ProjectStatus @default(PLANNING)
  
  // Financial
  contractTotal           Decimal  @db.Decimal(18, 2) // Valor total do contrato
  contractTotalOverride   Decimal? @db.Decimal(18, 2) // Override manual (opcional)
  currentTotalOverride    Decimal? @db.Decimal(18, 2)
  bdi                     Decimal  @default(0) @db.Decimal(5, 2) // BDI em %
  
  // Measurement Control
  measurementNumber Int      @default(0) // Número da medição atual
  referenceDate     DateTime @default(now()) // Data de referência da medição
  
  // Branding
  logoUrl String? // URL para logo no storage (S3/R2)
  
  // Configuration
  strictMode       Boolean @default(false) // Modo rigoroso de validação
  printCards       Boolean @default(true)
  printSubtotals   Boolean @default(true)
  showSignatures   Boolean @default(true)
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  
  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  groupId String?
  group   ProjectGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  
  creatorId String
  creator   User   @relation("ProjectCreator", fields: [creatorId], references: [id], onDelete: Restrict)
  
  members             ProjectMember[]
  workItems           WorkItem[]
  measurementSnapshots MeasurementSnapshot[]
  assets              ProjectAsset[]
  expenses            ProjectExpense[]
  planningTasks       PlanningTask[]
  materialForecasts   MaterialForecast[]
  milestones          Milestone[]
  journalEntries      JournalEntry[]
  theme               ProjectTheme?
  
  @@index([organizationId])
  @@index([groupId])
  @@index([creatorId])
  @@index([status])
}

// ============================================================================
// 3. WORK BREAKDOWN STRUCTURE (WBS/EAP)
// ============================================================================

enum ItemType {
  CATEGORY // Agrupador hierárquico
  ITEM     // Item de serviço (folha da árvore)
}

model WorkItem {
  id          String   @id @default(cuid())
  description String   // Nome do item/categoria
  type        ItemType @default(ITEM)
  wbs         String   // Numeração hierárquica (ex: "1.2.3.1")
  order       Int      @default(0) // Ordem de exibição no nível
  
  // Technical Specs
  unit   String  @default("UN")
  code   String? // Código SINAPI/SBC/Próprio
  source String? // Fonte: SINAPI, SBC, PRÓPRIO
  
  // Contract Values
  contractQuantity Decimal @default(0) @db.Decimal(18, 4) // Quantidade contratual
  unitPrice        Decimal @default(0) @db.Decimal(18, 2) // Preço unitário COM BDI
  unitPriceNoBdi   Decimal @default(0) @db.Decimal(18, 2) // Preço unitário SEM BDI
  contractTotal    Decimal @default(0) @db.Decimal(18, 2) // Total contratual
  
  // Previous Measurement
  previousQuantity Decimal @default(0) @db.Decimal(18, 4)
  previousTotal    Decimal @default(0) @db.Decimal(18, 2)
  
  // Current Measurement
  currentQuantity   Decimal @default(0) @db.Decimal(18, 4)
  currentTotal      Decimal @default(0) @db.Decimal(18, 2)
  currentPercentage Decimal @default(0) @db.Decimal(5, 2) // % de execução
  
  // Accumulated
  accumulatedQuantity   Decimal @default(0) @db.Decimal(18, 4)
  accumulatedTotal      Decimal @default(0) @db.Decimal(18, 2)
  accumulatedPercentage Decimal @default(0) @db.Decimal(5, 2)
  
  // Balance
  balanceQuantity Decimal @default(0) @db.Decimal(18, 4)
  balanceTotal    Decimal @default(0) @db.Decimal(18, 2)
  
  // Hierarchy (Flattened Representation)
  parentId String? // Auto-relacionamento
  
  // Relations
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  parent   WorkItem?  @relation("WorkItemHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children WorkItem[] @relation("WorkItemHierarchy")
  
  linkedExpenses   ProjectExpense[]
  linkedJournalEntries JournalEntry[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([projectId])
  @@index([parentId])
  @@index([wbs])
  @@index([type])
}

// ============================================================================
// 4. MEASUREMENT SNAPSHOTS (Time Machine)
// ============================================================================

model MeasurementSnapshot {
  id                String   @id @default(cuid())
  measurementNumber Int      // Número da medição
  referenceDate     DateTime // Data de referência
  
  // Snapshot Totals (desnormalizado para performance)
  contractTotal    Decimal @db.Decimal(18, 2)
  periodTotal      Decimal @db.Decimal(18, 2)
  accumulatedTotal Decimal @db.Decimal(18, 2)
  progressPercent  Decimal @db.Decimal(5, 2)
  
  // Frozen State (JSON serializado do estado completo)
  itemsSnapshot Json // Array de WorkItems congelados
  
  // Relations
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([projectId, measurementNumber])
  @@index([projectId])
  @@index([referenceDate])
}

// ============================================================================
// 5. ASSETS & DOCUMENTS
// ============================================================================

model ProjectAsset {
  id       String @id @default(cuid())
  name     String
  fileType String // MIME type
  fileSize BigInt // Bytes
  
  // Storage
  storageKey  String  // S3/R2 key
  storageUrl  String? // Public URL (se aplicável)
  
  // Metadata
  uploadDate DateTime @default(now())
  
  // Relations
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@index([projectId])
}

// ============================================================================
// 6. FINANCIAL MANAGEMENT
// ============================================================================

enum ExpenseType {
  LABOR    // Mão de obra
  MATERIAL // Material
  REVENUE  // Receita
}

model ProjectExpense {
  id          String      @id @default(cuid())
  description String
  entityName  String      // Nome do fornecedor/funcionário
  
  type     ExpenseType
  itemType ItemType    @default(ITEM)
  
  // Hierarchy
  wbs      String
  order    Int     @default(0)
  parentId String?
  
  // Financial
  date            DateTime
  paymentDate     DateTime?
  unit            String    @default("UN")
  quantity        Decimal   @db.Decimal(18, 4)
  unitPrice       Decimal   @db.Decimal(18, 2)
  discountValue   Decimal?  @db.Decimal(18, 2)
  discountPercent Decimal?  @db.Decimal(5, 2)
  amount          Decimal   @db.Decimal(18, 2)
  isPaid          Boolean   @default(false)
  
  // Link to WorkItem (optional)
  linkedWorkItemId String?
  linkedWorkItem   WorkItem? @relation(fields: [linkedWorkItemId], references: [id], onDelete: SetNull)
  
  // Relations
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  parent   ProjectExpense?  @relation("ExpenseHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children ProjectExpense[] @relation("ExpenseHierarchy")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([projectId])
  @@index([type])
  @@index([date])
  @@index([linkedWorkItemId])
}

// ============================================================================
// 7. PLANNING & FORECASTING
// ============================================================================

model PlanningTask {
  id          String   @id @default(cuid())
  categoryId  String?  // Categoria customizada (ex: "Estrutura", "Alvenaria")
  description String
  isCompleted Boolean  @default(false)
  dueDate     DateTime
  completedAt DateTime?
  
  // Relations
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([projectId])
  @@index([dueDate])
}

enum ForecastStatus {
  PENDING   // Aguardando compra
  ORDERED   // Pedido realizado
  DELIVERED // Entregue
}

model MaterialForecast {
  id             String         @id @default(cuid())
  description    String
  quantityNeeded Decimal        @db.Decimal(18, 4)
  unit           String
  estimatedDate  DateTime
  status         ForecastStatus @default(PENDING)
  
  // Relations
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([projectId])
  @@index([status])
  @@index([estimatedDate])
}

model Milestone {
  id          String   @id @default(cuid())
  title       String
  date        DateTime
  isCompleted Boolean  @default(false)
  
  // Relations
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([projectId])
  @@index([date])
}

// ============================================================================
// 8. JOURNAL & AUDIT TRAIL
// ============================================================================

enum JournalCategory {
  PROGRESS  // Avanço de obra
  FINANCIAL // Evento financeiro
  INCIDENT  // Ocorrência/Problema
  WEATHER   // Clima
}

enum WeatherType {
  SUNNY
  RAINY
  CLOUDY
  STORM
}

model JournalEntry {
  id          String          @id @default(cuid())
  timestamp   DateTime        @default(now())
  type        String          @default("MANUAL") // AUTO ou MANUAL
  category    JournalCategory
  title       String
  description String          @db.Text
  
  // Optional fields
  weatherStatus WeatherType?
  photoUrls     String[] // Array de URLs (S3/R2)
  
  // Link to WorkItem (optional)
  linkedItemId String?
  linkedItem   WorkItem? @relation(fields: [linkedItemId], references: [id], onDelete: SetNull)
  
  // Relations
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Restrict)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([projectId])
  @@index([timestamp])
  @@index([category])
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  entityType String   // WORK_ITEM, PROJECT, USER, etc.
  entityId   String   // ID da entidade afetada
  
  // Snapshot of changes (JSONB for performance)
  oldValue Json? // Estado anterior
  newValue Json? // Estado novo
  
  // Metadata
  ipAddress String?
  userAgent String?
  timestamp DateTime @default(now())
  
  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([userId])
}

// ============================================================================
// 9. BIDDING MANAGEMENT
// ============================================================================

enum BiddingStatus {
  PROSPECTING // Prospecção
  DRAFTING    // Elaboração de proposta
  SUBMITTED   // Proposta enviada
  WON         // Vencemos
  LOST        // Perdemos
}

model BiddingProcess {
  id              String        @id @default(cuid())
  tenderNumber    String        // Número do edital
  clientName      String        // Órgão/Cliente
  object          String        @db.Text // Objeto da licitação
  openingDate     DateTime
  visitDate       DateTime?
  expirationDate  DateTime
  estimatedValue  Decimal       @db.Decimal(18, 2)
  ourProposalValue Decimal      @db.Decimal(18, 2)
  status          BiddingStatus @default(PROSPECTING)
  bdi             Decimal       @default(0) @db.Decimal(5, 2)
  
  // Serialized data (migração temporária - pode ser normalizado depois)
  itemsJson  Json // Array de WorkItems da proposta
  assetsJson Json // Array de anexos
  
  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([organizationId])
  @@index([status])
  @@index([openingDate])
}

model CompanyCertificate {
  id             String   @id @default(cuid())
  name           String
  issuer         String
  expirationDate DateTime
  fileUrl        String?  // URL no storage
  status         String   // valid, warning, expired (calculado no app)
  
  // Relations
  globalSettingsId String
  globalSettings   GlobalSettings @relation(fields: [globalSettingsId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([expirationDate])
}

// ============================================================================
// 10. GLOBAL SETTINGS & THEMING
// ============================================================================

model GlobalSettings {
  id                 String   @id @default(cuid())
  defaultCompanyName String
  companyCnpj        String?
  userName           String?
  language           String   @default("pt-BR")
  currencySymbol     String   @default("R$")
  
  // Relations
  organizationId String       @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  certificates CompanyCertificate[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProjectTheme {
  id             String @id @default(cuid())
  fontFamily     String @default("Inter")
  primary        String @default("#000000")
  accent         String @default("#2563eb")
  accentText     String @default("#ffffff")
  border         String @default("#000000")
  currencySymbol String @default("R$")
  
  // Box themes (JSONB)
  headerTheme      Json // { bg: string, text: string }
  categoryTheme    Json
  footerTheme      Json
  kpiHighlightTheme Json
  
  // Relations
  projectId String  @unique
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
