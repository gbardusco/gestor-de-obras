[
  {
    "id": 14,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "**Contexto:**\nEstou desenvolvendo um sistema de gestão de obras. O sistema já possui funcionalidades de planejamento (`MaterialForecast`) e financeiro (`ProjectExpense`). Atualmente, o usuário lança itens um a um. Preciso de uma nova funcionalidade para lançar uma \"Lista de Compras\" (lote de materiais) de uma só vez através de um modal centralizador.\n\n**Tarefa:**\nCrie um componente React chamado `PurchaseListModal.tsx` e atualize a lógica de serviço para suportar o salvamento em lote.\n\n**Requisitos Técnicos:**\n\n1. **Interface da Tabela:** Dentro do modal, deve haver uma tabela dinâmica onde o usuário pode adicionar múltiplas linhas. Cada linha representa um produto/material.\n2. **Campos por Item (Versão Reduzida):** Cada linha da tabela deve permitir editar: Descrição, Unidade, Quantidade, Preço Unitário, % de Desconto e Categoria (baseada no `ProjectAssetCategory` ou categorias de despesas).\n3. **Cálculo Automático:** O modal deve calcular o total de cada linha e o total geral da lista em tempo real, utilizando as funções de utilidade de `utils/math.ts` (como `financial.formatBRL`).\n4. **Anexo de PDF:** Na parte inferior do modal, deve haver um campo de upload (estilo `ExpenseAttachmentZone`) para anexar um único PDF (como a Nota Fiscal ou Orçamento) que será vinculado a todos os itens da lista.\n5. **Persistência:** Ao salvar, o componente deve iterar sobre a lista e chamar o serviço de criação (ex: `planningApi.createForecast` ou similar) para cada item, vinculando o mesmo ID de anexo a todos eles.\n6. **Estética:** Siga o padrão visual dos componentes existentes (`BiddingModal.tsx`, `ExpenseModal.tsx`):\n\n\n**Resultado Esperado:**\nO código completo do componente `PurchaseListModal.tsx` e as sugestões de alteração no `planningService.ts` ou `planningApi.ts` para processar o lote de materiais.",
      "files": [],
      "fileUploads": [],
      "cssBlocks": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1771021819,
      "nanos": 23000000
    }
  },
  {
    "id": 15,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Developing Batch Entry Modal**\n\nI'm working on the Purchase List modal component, which I've dubbed `PurchaseListModal.tsx`. It's designed for batch material entry, real-time total calculations, and a single PDF attachment for the entire purchase list. The goal is to streamline the material adding process and improve efficiency.\n\n\n**Implementing Batch Forecasts**\n\nI've made progress on the planning service, adding a `createBatchForecasts` method for material forecast creation. I'm also adding a new button to the UI in `PlanningView.tsx` to open the modal. My main focus now is on state management. I need to handle an array of item objects, the invoice PDF, calculated totals, and validation to ensure a material forecast with a valid description is made at least once.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1771021819,
      "nanos": 23000000
    },
    "doneTimestamp": {
      "seconds": 1771021826,
      "nanos": 572000000
    }
  },
  {
    "id": 16,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "Este é um pedido excelente para aumentar a produtividade operacional do sistema. Como Arquiteto de Software, estruturarei essa funcionalidade seguindo o padrão de **Entrada em Lote (Batch Entry)**, garantindo que a integridade dos dados e os cálculos financeiros permaneçam precisos.\n\n### Especificação Técnica da Implementação\n\n1.  **Componente `PurchaseListModal`**:\n    *   **Estado Interno**: Gerenciará um array de itens temporários com campos reativos.\n    *   **Cálculos em Tempo Real**: Utilizará `useMemo` para calcular o subtotal de cada linha e o valor global da nota.\n    *   **Anexo Compartilhado**: Um único `ExpenseAttachmentZone` que, ao receber o PDF, distribui o Base64 para todos os itens no momento do commit.\n    *   **UX de Tabela**: Suporte a adição rápida de linhas e remoção intuitiva.\n\n2.  **Atualização no `planningService`**:\n    *   Adição da função `processBatchForecasts` para mapear os itens da UI para o modelo de dados `MaterialForecast`, tratando a ordenação (`order`) e metadados comuns (datas e anexos).\n\n3.  **Integração na `PlanningView`**:\n    *   Novo gatilho visual \"Lista de Compras\" ao lado do botão \"Novo Insumo\".\n\n---\n\n### Implementação do Código\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1771021826,
      "nanos": 572000000
    },
    "doneTimestamp": {
      "seconds": 1771021826,
      "nanos": 572000000
    }
  },
  {
    "id": 17,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "services/planningService.ts",
          "generationType": 1,
          "isDone": true,
          "description": "Adição de lógica para processamento de lote de materiais e suprimentos.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport { ProjectPlanning, PlanningTask, MaterialForecast, Milestone, WorkItem, ProjectExpense, TaskStatus } from '../types';\n\nexport const planningService = {\n\n  generateTasksFromWbs: (planning: ProjectPlanning, workItems: WorkItem[]): ProjectPlanning => {\n    const unstartedItems = workItems.filter(item => \n      item.type === 'item' && \n      (item.contractQuantity || 0) > 0 && \n      (item.accumulatedQuantity || 0) === 0\n    );\n\n    const existingCategoryLinks = new Set(\n      (planning.tasks || []).map(t => t.categoryId).filter(id => id !== null)\n    );\n\n    const newTasks: PlanningTask[] = unstartedItems\n      .filter(item => !existingCategoryLinks.has(item.id))\n      .map(item => ({\n        id: crypto.randomUUID(),\n        categoryId: item.id,\n        description: `Iniciar execução: ${item.name}`,\n        isCompleted: false,\n        status: 'todo',\n        dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),\n        createdAt: new Date().toISOString()\n      }));\n\n    return {\n      ...planning,\n      tasks: [...(planning.tasks || []), ...newTasks]\n    };\n  },\n\n  getUrgencyLevel: (dateStr: string): 'urgent' | 'warning' | 'normal' => {\n    if (!dateStr) return 'normal';\n    \n    const dueDate = new Date(dateStr);\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    dueDate.setHours(0, 0, 0, 0);\n\n    const diffTime = dueDate.getTime() - today.getTime();\n    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n\n    if (diffDays < 0) return 'urgent';\n    if (diffDays <= 3) return 'urgent';\n    if (diffDays <= 7) return 'warning';\n    return 'normal';\n  },\n\n  prepareExpenseFromForecast: (forecast: MaterialForecast, parentId: string | null = null, purchaseDate?: string, isPaid: boolean = false): Partial<ProjectExpense> => {\n    const totalAmount = (forecast.quantityNeeded || 0) * (forecast.unitPrice || 0);\n    return {\n      id: crypto.randomUUID(),\n      parentId: parentId,\n      type: 'material',\n      itemType: 'item',\n      date: purchaseDate || new Date().toISOString().split('T')[0],\n      description: `Pedido de Compra: ${forecast.description}`,\n      unit: forecast.unit,\n      quantity: forecast.quantityNeeded,\n      unitPrice: forecast.unitPrice,\n      isPaid: isPaid, \n      amount: totalAmount,\n      status: isPaid ? 'PAID' : 'PENDING'\n    };\n  },\n\n  // NOVO: Processamento de Lote\n  processBatchForecasts: (planning: ProjectPlanning, items: any[], commonData: { supplierId?: string, date: string, proof?: string }): ProjectPlanning => {\n    const newForecasts: MaterialForecast[] = items.map((item, idx) => ({\n      id: crypto.randomUUID(),\n      description: item.description || 'Item Sem Descrição',\n      unit: item.unit || 'un',\n      quantityNeeded: item.quantity || 0,\n      unitPrice: item.unitPrice || 0,\n      estimatedDate: commonData.date,\n      status: 'pending',\n      isPaid: false,\n      order: planning.forecasts.length + idx,\n      supplierId: commonData.supplierId,\n      paymentProof: commonData.proof\n    }));\n\n    return {\n      ...planning,\n      forecasts: [...planning.forecasts, ...newForecasts]\n    };\n  },\n\n  addTask: (planning: ProjectPlanning, data: Partial<PlanningTask>): ProjectPlanning => {\n    const now = new Date().toISOString();\n    return {\n      ...planning,\n      tasks: [...(planning.tasks || []), {\n        id: crypto.randomUUID(),\n        categoryId: data.categoryId || null,\n        description: data.description?.trim() || 'Nova Tarefa',\n        isCompleted: data.status === 'done',\n        status: data.status || 'todo',\n        dueDate: data.dueDate || now,\n        createdAt: now\n      }]\n    };\n  },\n\n  updateTask: (planning: ProjectPlanning, taskId: string, updates: Partial<PlanningTask>): ProjectPlanning => {\n    const updatedTasks = planning.tasks.map(task => {\n      if (task.id !== taskId) return task;\n      \n      const merged = { ...task, ...updates };\n\n      if (updates.status) {\n        merged.isCompleted = updates.status === 'done';\n      }\n\n      if (merged.isCompleted && !merged.completedAt) {\n        merged.completedAt = new Date().toISOString();\n      } else if (!merged.isCompleted) {\n        merged.completedAt = undefined;\n      }\n\n      return merged;\n    });\n\n    return { ...planning, tasks: updatedTasks };\n  },\n\n  deleteTask: (planning: ProjectPlanning, taskId: string): ProjectPlanning => ({\n    ...planning,\n    tasks: (planning.tasks || []).filter(t => t.id !== taskId)\n  }),\n\n  addForecast: (planning: ProjectPlanning, data: Partial<MaterialForecast>): ProjectPlanning => ({\n    ...planning,\n    forecasts: [...(planning.forecasts || []), {\n      id: crypto.randomUUID(),\n      description: data.description || 'Insumo Previsto',\n      quantityNeeded: data.quantityNeeded || 0,\n      unitPrice: data.unitPrice || 0,\n      unit: data.unit || 'un',\n      estimatedDate: data.estimatedDate || new Date().toISOString(),\n      status: data.status || 'pending',\n      isPaid: data.isPaid || false,\n      order: planning.forecasts.length\n    }]\n  }),\n\n  updateForecast: (planning: ProjectPlanning, id: string, updates: Partial<MaterialForecast>): ProjectPlanning => ({\n    ...planning,\n    forecasts: (planning.forecasts || []).map(f => f.id === id ? { ...f, ...updates } : f)\n  }),\n\n  reorderForecasts: (planning: ProjectPlanning, id: string, direction: 'up' | 'down'): ProjectPlanning => {\n    const list = [...planning.forecasts].sort((a, b) => a.order - b.order);\n    const idx = list.findIndex(f => f.id === id);\n    if (idx === -1) return planning;\n    \n    const newIdx = direction === 'up' ? idx - 1 : idx + 1;\n    if (newIdx < 0 || newIdx >= list.length) return planning;\n    \n    const [movedItem] = list.splice(idx, 1);\n    list.splice(newIdx, 0, movedItem);\n    \n    const updatedList = list.map((item, i) => ({ ...item, order: i }));\n    \n    return { ...planning, forecasts: updatedList };\n  },\n\n  moveForecast: (planning: ProjectPlanning, sourceIndex: number, destinationIndex: number): ProjectPlanning => {\n    const list = [...planning.forecasts].sort((a, b) => a.order - b.order);\n    const [movedItem] = list.splice(sourceIndex, 1);\n    list.splice(destinationIndex, 0, movedItem);\n\n    const updatedList = list.map((item, i) => ({ ...item, order: i }));\n    return { ...planning, forecasts: updatedList };\n  },\n\n  deleteForecast: (planning: ProjectPlanning, id: string): ProjectPlanning => ({\n    ...planning,\n    forecasts: (planning.forecasts || []).filter(f => f.id !== id)\n  }),\n\n  addMilestone: (planning: ProjectPlanning, data: Partial<Milestone>): ProjectPlanning => ({\n    ...planning,\n    milestones: [...(planning.milestones || []), {\n      id: crypto.randomUUID(),\n      title: data.title || 'Nova Meta do Projeto',\n      date: data.date || new Date().toISOString(),\n      isCompleted: !!data.isCompleted\n    }]\n  }),\n\n  updateMilestone: (planning: ProjectPlanning, id: string, updates: Partial<Milestone>): ProjectPlanning => ({\n    ...planning,\n    milestones: (planning.milestones || []).map(m => m.id === id ? { ...m, ...updates } : m)\n  }),\n\n  deleteMilestone: (planning: ProjectPlanning, id: string): ProjectPlanning => ({\n    ...planning,\n    milestones: (planning.milestones || []).filter(m => m.id !== id)\n  }),\n\n  cleanupOrphanedTasks: (planning: ProjectPlanning, currentItems: WorkItem[]): ProjectPlanning => {\n    const validIds = new Set(currentItems.map(i => i.id));\n    const sanitizedTasks = (planning.tasks || []).map(task => {\n      if (task.categoryId && !validIds.has(task.categoryId)) {\n        return { ...task, categoryId: null };\n      }\n      return task;\n    });\n    return { ...planning, tasks: sanitizedTasks };\n  }\n};\n"
            }
          ]
        },
        {
          "path": "components/PurchaseListModal.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Criação do modal de lançamento de lote de compras de materiais.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useMemo, useEffect } from 'react';\nimport { X, Plus, Trash2, Save, ShoppingCart, Calculator, Calendar, Building2, FileText, CheckCircle2 } from 'lucide-react';\nimport { financial } from '../utils/math';\nimport { Supplier } from '../types';\nimport { ExpenseAttachmentZone } from './ExpenseAttachmentZone';\n\ninterface PurchaseListItem {\n  id: string;\n  description: string;\n  unit: string;\n  quantity: number;\n  unitPrice: number;\n  discountPercent: number;\n}\n\ninterface PurchaseListModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onSave: (items: any[], commonData: { supplierId?: string, date: string, proof?: string }) => void;\n  suppliers: Supplier[];\n}\n\nexport const PurchaseListModal: React.FC<PurchaseListModalProps> = ({ isOpen, onClose, onSave, suppliers }) => {\n  const [items, setItems] = useState<PurchaseListItem[]>([\n    { id: crypto.randomUUID(), description: '', unit: 'un', quantity: 1, unitPrice: 0, discountPercent: 0 }\n  ]);\n  const [commonDate, setCommonDate] = useState(new Date().toISOString().split('T')[0]);\n  const [commonSupplierId, setCommonSupplierId] = useState('');\n  const [commonProof, setCommonProof] = useState<string | undefined>();\n\n  const addItem = () => {\n    setItems([...items, { id: crypto.randomUUID(), description: '', unit: 'un', quantity: 1, unitPrice: 0, discountPercent: 0 }]);\n  };\n\n  const removeItem = (id: string) => {\n    if (items.length > 1) {\n      setItems(items.filter(i => i.id !== id));\n    }\n  };\n\n  const updateItem = (id: string, field: keyof PurchaseListItem, value: any) => {\n    setItems(items.map(i => i.id === id ? { ...i, [field]: value } : i));\n  };\n\n  const totals = useMemo(() => {\n    return items.reduce((acc, curr) => {\n      const subtotal = (curr.quantity || 0) * (curr.unitPrice || 0);\n      const discount = subtotal * ((curr.discountPercent || 0) / 100);\n      return acc + (subtotal - discount);\n    }, 0);\n  }, [items]);\n\n  if (!isOpen) return null;\n\n  return (\n    <div className=\"fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-sm animate-in fade-in duration-300\" onClick={onClose}>\n      <div className=\"bg-[#0f111a] w-full max-w-6xl rounded-[3rem] border border-slate-800/50 shadow-2xl flex flex-col overflow-hidden max-h-[95vh] relative\" onClick={e => e.stopPropagation()}>\n        <div className=\"absolute top-0 left-1/2 -translate-x-1/2 w-96 h-64 bg-indigo-500/5 blur-[120px] pointer-events-none\"></div>\n\n        {/* Header */}\n        <div className=\"p-10 pb-6 shrink-0 flex items-center justify-between z-10 border-b border-slate-800/50\">\n          <div className=\"flex items-center gap-5\">\n            <div className=\"p-4 bg-slate-800/60 rounded-3xl border border-slate-700/50 text-indigo-500 shadow-xl\">\n              <ShoppingCart size={28} />\n            </div>\n            <div>\n              <h2 className=\"text-2xl font-black text-white uppercase tracking-tighter leading-none\">Lançamento em Lote</h2>\n              <p className=\"text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1\">Lista de Materiais e Suprimentos</p>\n            </div>\n          </div>\n          <button onClick={onClose} className=\"p-3 text-slate-500 hover:text-white transition-all rounded-2xl hover:bg-slate-800/50\">\n            <X size={24} />\n          </button>\n        </div>\n\n        {/* Content */}\n        <div className=\"p-10 flex-1 overflow-y-auto custom-scrollbar z-10 space-y-8\">\n          {/* Common Meta */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8 p-8 bg-slate-900/40 rounded-[2.5rem] border border-slate-800/60\">\n            <div className=\"space-y-4\">\n              <label className=\"text-[10px] font-black text-slate-400 uppercase tracking-widest block ml-1\">Dados de Faturamento (Comuns)</label>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"relative\">\n                  <Building2 className=\"absolute left-4 top-1/2 -translate-y-1/2 text-slate-600\" size={16} />\n                  <select \n                    className=\"w-full pl-11 pr-4 py-4 rounded-2xl bg-slate-950 border border-slate-800 text-white text-xs font-bold outline-none focus:border-indigo-600 transition-all appearance-none\"\n                    value={commonSupplierId}\n                    onChange={e => setCommonSupplierId(e.target.value)}\n                  >\n                    <option value=\"\">Fornecedor Spot</option>\n                    {suppliers.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}\n                  </select>\n                </div>\n                <div className=\"relative\">\n                  <Calendar className=\"absolute left-4 top-1/2 -translate-y-1/2 text-slate-600\" size={16} />\n                  <input \n                    type=\"date\"\n                    className=\"w-full pl-11 pr-4 py-4 rounded-2xl bg-slate-950 border border-slate-800 text-white text-xs font-bold outline-none focus:border-indigo-600 transition-all [color-scheme:dark]\"\n                    value={commonDate}\n                    onChange={e => setCommonDate(e.target.value)}\n                  />\n                </div>\n              </div>\n            </div>\n            \n            <div className=\"space-y-4\">\n              <label className=\"text-[10px] font-black text-slate-400 uppercase tracking-widest block ml-1\">Anexo Único (NF/Orçamento)</label>\n              <ExpenseAttachmentZone \n                label=\"Documento da Compra\"\n                currentFile={commonProof}\n                onUpload={setCommonProof}\n                onRemove={() => setCommonProof(undefined)}\n              />\n            </div>\n          </div>\n\n          {/* Table */}\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between px-2\">\n              <h3 className=\"text-[10px] font-black text-slate-500 uppercase tracking-widest\">Itens da Lista</h3>\n              <button onClick={addItem} className=\"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-500 transition-all\">\n                <Plus size={14} /> Adicionar Linha\n              </button>\n            </div>\n\n            <div className=\"border border-slate-800/60 rounded-[2.5rem] overflow-hidden\">\n              <table className=\"w-full text-left\">\n                <thead>\n                  <tr className=\"bg-slate-900/50 text-[9px] font-black uppercase tracking-widest text-slate-400\">\n                    <th className=\"px-6 py-5\">Descrição do Material</th>\n                    <th className=\"px-4 py-5 text-center w-24\">Und</th>\n                    <th className=\"px-4 py-5 text-center w-28\">Qtd</th>\n                    <th className=\"px-4 py-5 text-right w-40\">P. Unitário</th>\n                    <th className=\"px-4 py-5 text-center w-24\">Desc %</th>\n                    <th className=\"px-4 py-5 text-right w-44\">Total Líquido</th>\n                    <th className=\"px-6 py-5 w-16\"></th>\n                  </tr>\n                </thead>\n                <tbody className=\"divide-y divide-slate-800/40\">\n                  {items.map((item, idx) => {\n                    const rowTotal = (item.quantity * item.unitPrice) * (1 - (item.discountPercent / 100));\n                    return (\n                      <tr key={item.id} className=\"group bg-slate-900/10 hover:bg-slate-800/20 transition-colors\">\n                        <td className=\"px-6 py-4\">\n                          <input \n                            placeholder=\"Ex: Ferro 10mm CA-50\"\n                            className=\"w-full bg-transparent text-white text-sm font-black outline-none placeholder:text-slate-700\"\n                            value={item.description}\n                            onChange={e => updateItem(item.id, 'description', e.target.value)}\n                          />\n                        </td>\n                        <td className=\"px-4 py-4\">\n                          <input \n                            className=\"w-full bg-slate-950/50 border border-slate-800 rounded-lg px-2 py-2 text-center text-xs font-bold text-slate-400 uppercase\"\n                            value={item.unit}\n                            onChange={e => updateItem(item.id, 'unit', e.target.value)}\n                          />\n                        </td>\n                        <td className=\"px-4 py-4\">\n                          <input \n                            type=\"number\"\n                            className=\"w-full bg-slate-950/50 border border-slate-800 rounded-lg px-2 py-2 text-center text-xs font-black text-white\"\n                            value={item.quantity}\n                            onChange={e => updateItem(item.id, 'quantity', parseFloat(e.target.value) || 0)}\n                          />\n                        </td>\n                        <td className=\"px-4 py-4\">\n                          <div className=\"flex items-center gap-2 px-3 py-2 bg-slate-950/50 border border-slate-800 rounded-lg\">\n                            <span className=\"text-[10px] text-slate-600 font-black\">R$</span>\n                            <input \n                              type=\"number\"\n                              className=\"w-full bg-transparent text-right text-xs font-black text-white outline-none\"\n                              value={item.unitPrice}\n                              onChange={e => updateItem(item.id, 'unitPrice', parseFloat(e.target.value) || 0)}\n                            />\n                          </div>\n                        </td>\n                        <td className=\"px-4 py-4\">\n                          <input \n                            type=\"number\"\n                            className=\"w-full bg-slate-950/50 border border-slate-800 rounded-lg px-2 py-2 text-center text-xs font-black text-rose-500\"\n                            value={item.discountPercent}\n                            onChange={e => updateItem(item.id, 'discountPercent', parseFloat(e.target.value) || 0)}\n                          />\n                        </td>\n                        <td className=\"px-4 py-4 text-right\">\n                          <span className=\"text-sm font-black text-indigo-400\">\n                            {financial.formatVisual(rowTotal, 'R$')}\n                          </span>\n                        </td>\n                        <td className=\"px-6 py-4 text-right\">\n                          <button \n                            disabled={items.length === 1}\n                            onClick={() => removeItem(item.id)}\n                            className=\"p-2 text-slate-600 hover:text-rose-500 transition-colors disabled:opacity-20\"\n                          >\n                            <Trash2 size={16} />\n                          </button>\n                        </td>\n                      </tr>\n                    );\n                  })}\n                </tbody>\n              </table>\n            </div>\n          </div>\n        </div>\n\n        {/* Footer */}\n        <div className=\"p-10 pt-6 border-t border-slate-800/50 bg-[#0f111a]/80 backdrop-blur-md flex flex-col md:flex-row items-center justify-between gap-6 z-20\">\n          <div className=\"flex items-center gap-8\">\n            <div className=\"flex flex-col\">\n              <span className=\"text-[9px] font-black text-slate-500 uppercase tracking-widest\">Total da Lista</span>\n              <div className=\"flex items-center gap-3\">\n                <Calculator size={20} className=\"text-indigo-500\" />\n                <p className=\"text-3xl font-black text-white tracking-tighter\">\n                  {financial.formatVisual(totals, 'R$')}\n                </p>\n              </div>\n            </div>\n            <div className=\"h-10 w-px bg-slate-800 hidden md:block\" />\n            <div className=\"flex items-center gap-2 px-4 py-2 bg-slate-900 rounded-2xl border border-slate-800\">\n              <CheckCircle2 size={14} className=\"text-emerald-500\" />\n              <span className=\"text-[10px] font-black text-slate-400 uppercase\">{items.length} Materiais Lançados</span>\n            </div>\n          </div>\n\n          <div className=\"flex items-center gap-4 w-full md:w-auto\">\n            <button onClick={onClose} className=\"px-8 py-5 text-slate-500 font-black uppercase text-xs tracking-widest hover:text-white transition-colors\">Voltar</button>\n            <button \n              onClick={() => onSave(items, { supplierId: commonSupplierId, date: commonDate, proof: commonProof })}\n              disabled={items.some(i => !i.description)}\n              className=\"flex-1 md:flex-none px-12 py-5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-[2rem] font-black uppercase text-xs tracking-widest shadow-[0_15px_35px_-10px_rgba(79,70,229,0.5)] active:scale-95 transition-all flex items-center justify-center gap-3 disabled:opacity-30 disabled:cursor-not-allowed\"\n            >\n              <Save size={20} /> Salvar Lote de Materiais\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n"
            }
          ]
        },
        {
          "path": "components/PlanningView.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Integração do botão de Lista de Compras e novo modal.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useMemo, useRef, useEffect } from 'react';\nimport { Project, PlanningTask, MaterialForecast, Milestone, WorkItem, TaskStatus, ProjectPlanning, ProjectExpense, Supplier } from '../types';\nimport { planningService } from '../services/planningService';\nimport { excelService } from '../services/excelService';\nimport { financial } from '../utils/math';\nimport { \n  CheckCircle2, Circle, Clock, Package, Flag, Plus, \n  Trash2, Calendar, AlertCircle, ShoppingCart, Truck, Search,\n  Wand2, ArrowUpRight, Ban, ListChecks, Boxes, Target,\n  GripVertical, MoreVertical, Edit2, X, Save, Calculator, Wallet, Link,\n  ChevronUp, ChevronDown, List, CalendarDays, Filter, Users, Download, UploadCloud,\n  Layers, FlagTriangleRight, Printer, CreditCard, ChevronLeft, ChevronRight,\n  HardHat, Building2, User, FolderTree, FileCheck, ReceiptText, FileText, FileSpreadsheet,\n  ArrowRight, FileStack\n} from 'lucide-react';\nimport { DragDropContext, Droppable, Draggable, DropResult } from '@hello-pangea/dnd';\nimport { ExpenseAttachmentZone } from './ExpenseAttachmentZone';\nimport { PurchaseListModal } from './PurchaseListModal';\n\ninterface PlanningViewProps {\n  project: Project;\n  suppliers: Supplier[];\n  onUpdatePlanning: (planning: ProjectPlanning) => void;\n  onAddExpense: (expense: ProjectExpense) => void;\n  categories: WorkItem[];\n  allWorkItems: WorkItem[];\n}\n\nexport const PlanningView: React.FC<PlanningViewProps> = ({ \n  project, suppliers, onUpdatePlanning, onAddExpense, categories, allWorkItems \n}) => {\n  const [activeSubTab, setActiveSubTab] = useState<'tasks' | 'forecast' | 'milestones'>('tasks');\n  const [editingTask, setEditingTask] = useState<PlanningTask | null>(null);\n  const [confirmingForecast, setConfirmingForecast] = useState<MaterialForecast | null>(null);\n  const [isAddingForecast, setIsAddingForecast] = useState(false);\n  const [isPurchaseListOpen, setIsPurchaseListOpen] = useState(false);\n  const [editingForecast, setEditingForecast] = useState<MaterialForecast | null>(null);\n  const [isDeletingForecast, setIsDeletingForecast] = useState<MaterialForecast | null>(null);\n  const [isAddingTask, setIsAddingTask] = useState<TaskStatus | null>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  \n  const [milestoneView, setMilestoneView] = useState<'list' | 'calendar'>('list');\n  const [editingMilestone, setEditingMilestone] = useState<Milestone | null>(null);\n  const [isAddingMilestone, setIsAddingMilestone] = useState(false);\n\n  const [forecastSearch, setForecastSearch] = useState('');\n  const [forecastStatusFilter, setForecastStatusFilter] = useState<'pending' | 'ordered' | 'delivered'>('pending');\n  \n  const planning = project.planning;\n\n  const financialCategories = useMemo(() => {\n    return project.expenses.filter(e => e.itemType === 'category' && e.type === 'labor');\n  }, [project.expenses]);\n\n  const sortedForecasts = useMemo(() => {\n    return [...planning.forecasts].sort((a, b) => a.order - b.order)\n      .filter(f => {\n        const matchesSearch = f.description.toLowerCase().includes(forecastSearch.toLowerCase());\n        const matchesStatus = f.status === forecastStatusFilter;\n        return matchesSearch && matchesStatus;\n      });\n  }, [planning.forecasts, forecastSearch, forecastStatusFilter]);\n\n  const forecastStats = useMemo(() => {\n    const list = planning.forecasts || [];\n    const total = list.reduce((acc, f) => acc + ((f.quantityNeeded || 0) * (f.unitPrice || 0)), 0);\n    \n    const countPending = list.filter(f => f.status === 'pending').length;\n    const countOrdered = list.filter(f => f.status === 'ordered').length;\n    const countDelivered = list.filter(f => f.status === 'delivered').length;\n\n    const pending = list.filter(f => f.status === 'pending').reduce((acc, f) => acc + ((f.quantityNeeded || 0) * (f.unitPrice || 0)), 0);\n    const ordered = list.filter(f => f.status === 'ordered').reduce((acc, f) => acc + ((f.quantityNeeded || 0) * (f.unitPrice || 0)), 0);\n    const delivered = list.filter(f => f.status === 'delivered').reduce((acc, f) => acc + ((f.quantityNeeded || 0) * (f.unitPrice || 0)), 0);\n    \n    return { total, pending, ordered, delivered, countPending, countOrdered, countDelivered };\n  }, [planning.forecasts]);\n\n  const handleAutoGenerate = () => {\n    const updated = planningService.generateTasksFromWbs(planning, allWorkItems);\n    onUpdatePlanning(updated);\n  };\n\n  const onDragEnd = (result: DropResult) => {\n    if (!result.destination) return;\n    const { draggableId, destination, source } = result;\n    if (activeSubTab === 'tasks') {\n      const newStatus = destination.droppableId as TaskStatus;\n      const updated = planningService.updateTask(planning, draggableId, { status: newStatus });\n      onUpdatePlanning(updated);\n    } else if (activeSubTab === 'forecast') {\n      const updated = planningService.moveForecast(planning, source.index, destination.index);\n      onUpdatePlanning(updated);\n    }\n  };\n\n  const handleAddTask = (data: Partial<PlanningTask>) => {\n    const updated = planningService.addTask(planning, data);\n    onUpdatePlanning(updated);\n    setIsAddingTask(null);\n  };\n\n  const handleUpdateTask = (id: string, data: Partial<PlanningTask>) => {\n    const updated = planningService.updateTask(planning, id, data);\n    onUpdatePlanning(updated);\n  };\n\n  const handleFinalizePurchase = (forecast: MaterialForecast, parentId: string | null, isPaid: boolean, proof?: string, purchaseDate?: string) => {\n    const expenseData = planningService.prepareExpenseFromForecast(forecast, parentId, purchaseDate, isPaid);\n    if (isPaid && proof) {\n      expenseData.paymentProof = proof;\n    }\n    \n    onAddExpense(expenseData as ProjectExpense);\n    \n    const updatedPlanning = planningService.updateForecast(planning, forecast.id, { \n      status: 'ordered', \n      isPaid: isPaid, \n      paymentProof: proof,\n      purchaseDate: purchaseDate || new Date().toISOString().split('T')[0]\n    });\n    onUpdatePlanning(updatedPlanning);\n    setConfirmingForecast(null);\n    setForecastStatusFilter('ordered');\n  };\n\n  const handleBatchSave = (items: any[], commonData: { supplierId?: string, date: string, proof?: string }) => {\n    const updated = planningService.processBatchForecasts(planning, items, commonData);\n    onUpdatePlanning(updated);\n    setIsPurchaseListOpen(false);\n  };\n\n  const handleViewProof = (proof: string) => {\n    const win = window.open();\n    win?.document.write(`<iframe src=\"${proof}\" frameborder=\"0\" style=\"border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;\" allowfullscreen></iframe>`);\n  };\n\n  const handleImportPlanning = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n    try {\n      const newPlanning = await excelService.parsePlanningExcel(file);\n      onUpdatePlanning(newPlanning);\n    } catch (err) {\n      alert(\"Erro ao importar planejamento.\");\n    } finally {\n      if (fileInputRef.current) fileInputRef.current.value = '';\n    }\n  };\n\n  const columns: { id: TaskStatus, label: string, color: string }[] = [\n    { id: 'todo', label: 'Planejado', color: 'indigo' },\n    { id: 'doing', label: 'Executando', color: 'amber' },\n    { id: 'done', label: 'Concluído', color: 'emerald' }\n  ];\n\n  return (\n    <div className=\"space-y-8 animate-in fade-in slide-in-from-bottom-6 duration-700\">\n      <input \n        type=\"file\" \n        ref={fileInputRef} \n        className=\"hidden\" \n        accept=\".xlsx, .xls\" \n        onChange={handleImportPlanning}\n      />\n      \n      <div className=\"no-print flex flex-col md:flex-row md:items-center justify-between gap-6 bg-white dark:bg-slate-900 p-8 rounded-[3rem] border border-slate-200 dark:border-slate-800 shadow-xl\">\n        <div className=\"flex items-center gap-5\">\n          <div className=\"p-4 bg-indigo-600 rounded-[1.5rem] text-white shadow-xl shadow-indigo-500/20\">\n            <HardHat size={28} />\n          </div>\n          <div>\n            <h2 className=\"text-2xl font-black text-slate-800 dark:text-white tracking-tight\">Planejamento Operacional</h2>\n            <div className=\"flex flex-wrap items-center gap-2 mt-1\">\n              <p className=\"text-[10px] text-slate-400 font-bold uppercase tracking-[0.2em]\">Gestão Ágil de Canteiro</p>\n              <div className=\"h-3 w-px bg-slate-200 dark:bg-slate-700 mx-1\" />\n              <button \n                onClick={() => window.print()}\n                className=\"text-[10px] font-black uppercase text-indigo-600 flex items-center gap-1.5 hover:bg-indigo-50 dark:hover:bg-indigo-900/40 px-2 py-1 rounded-lg transition-all\"\n              >\n                <Printer size={14}/> Imprimir\n              </button>\n              <div className=\"h-3 w-px bg-slate-200 dark:bg-slate-700 mx-1\" />\n              <div className=\"flex items-center gap-1\">\n                <button \n                  onClick={() => fileInputRef.current?.click()}\n                  className=\"p-1.5 text-slate-400 hover:text-emerald-600 transition-colors\"\n                  title=\"Importar Excel\"\n                >\n                  <UploadCloud size={16}/>\n                </button>\n                <button \n                  onClick={() => excelService.exportPlanningToExcel(project)}\n                  className=\"p-1.5 text-slate-400 hover:text-blue-600 transition-colors\"\n                  title=\"Exportar Excel\"\n                >\n                  <Download size={16}/>\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"flex bg-slate-100 dark:bg-slate-800 p-1.5 rounded-2xl gap-1 overflow-x-auto no-scrollbar\">\n          <SubTabBtn active={activeSubTab === 'tasks'} onClick={() => setActiveSubTab('tasks')} label=\"Quadro Kanban\" icon={<ListChecks size={14}/>} />\n          <SubTabBtn active={activeSubTab === 'forecast'} onClick={() => setActiveSubTab('forecast')} label=\"Suprimentos\" icon={<Boxes size={14}/>} />\n          <SubTabBtn active={activeSubTab === 'milestones'} onClick={() => setActiveSubTab('milestones')} label=\"Cronograma\" icon={<Target size={14}/>} />\n        </div>\n      </div>\n\n      <DragDropContext onDragEnd={onDragEnd}>\n        {activeSubTab === 'tasks' && (\n          <div className=\"space-y-6\">\n            <div className=\"flex justify-between items-center px-4\">\n               <div className=\"flex items-center gap-2\">\n                  <span className=\"w-3 h-3 rounded-full bg-indigo-500 animate-pulse\" />\n                  <h3 className=\"text-xs font-black uppercase tracking-widest text-slate-400\">Fluxo de Trabalho</h3>\n               </div>\n               <button onClick={handleAutoGenerate} className=\"flex items-center gap-2 px-6 py-3 bg-white dark:bg-slate-900 border border-indigo-200 dark:border-slate-700 text-indigo-600 dark:text-indigo-400 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-600 hover:text-white transition-all shadow-sm\">\n                  <Wand2 size={16} /> Inteligência EAP\n               </button>\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6 items-start\">\n              {columns.map(col => (\n                <div key={col.id} className=\"bg-slate-100/50 dark:bg-slate-900/40 rounded-[2.5rem] flex flex-col min-h-[600px] border border-transparent hover:border-slate-200 dark:hover:border-slate-800 transition-colors\">\n                  <div className=\"p-6 flex items-center justify-between shrink-0\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className={`w-2 h-6 rounded-full bg-${col.color}-500`} />\n                      <span className=\"text-xs font-black uppercase tracking-widest text-slate-700 dark:text-slate-300\">{col.label}</span>\n                      <span className=\"bg-white dark:bg-slate-800 text-[10px] font-black px-2 py-0.5 rounded-lg border border-slate-200 dark:border-slate-700\">{planning.tasks.filter(t => (t.status || (t.isCompleted ? 'done' : 'todo')) === col.id).length}</span>\n                    </div>\n                    <button onClick={() => setIsAddingTask(col.id)} className=\"p-2 bg-white dark:bg-slate-800 rounded-xl text-slate-400 hover:text-indigo-600 shadow-sm transition-all\"><Plus size={16}/></button>\n                  </div>\n\n                  <Droppable droppableId={col.id}>\n                    {(provided, snapshot) => (\n                      <div \n                        {...provided.droppableProps} \n                        ref={provided.innerRef}\n                        className={`flex-1 p-4 space-y-3 transition-colors rounded-[2rem] ${snapshot.isDraggingOver ? 'bg-indigo-50/50 dark:bg-indigo-900/10' : ''}`}\n                      >\n                        {planning.tasks\n                          .filter(t => (t.status || (t.isCompleted ? 'done' : 'todo')) === col.id)\n                          .map((task, index) => (\n                            <Draggable key={task.id} draggableId={task.id} index={index}>\n                              {(p, s) => (\n                                <div \n                                  ref={p.innerRef} \n                                  {...p.draggableProps}\n                                  onClick={() => setEditingTask(task)}\n                                  className={`group bg-white dark:bg-slate-900 p-5 rounded-3xl border transition-all cursor-pointer select-none hover:shadow-xl hover:-translate-y-1 ${s.isDragging ? 'shadow-2xl ring-2 ring-indigo-500 z-50' : 'border-slate-100 dark:border-slate-800 shadow-sm'}`}\n                                >\n                                  <div className=\"flex items-start justify-between gap-3 mb-3\">\n                                    <div {...p.dragHandleProps} className=\"p-1 text-slate-300 hover:text-indigo-500\"><GripVertical size={14}/></div>\n                                    <button onClick={(e) => { e.stopPropagation(); onUpdatePlanning(planningService.deleteTask(planning, task.id)); }} className=\"opacity-0 group-hover:opacity-100 p-1 text-slate-300 hover:text-rose-500 transition-all\"><Trash2 size={14}/></button>\n                                  </div>\n                                  <h4 className={`text-sm font-bold leading-relaxed whitespace-normal break-words ${task.isCompleted ? 'text-slate-400 line-through' : 'text-slate-800 dark:text-white'}`}>\n                                    {task.description}\n                                  </h4>\n                                  <div className=\"mt-4 flex flex-wrap items-center gap-2\">\n                                     <div className={`flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-[9px] font-black uppercase tracking-widest ${\n                                       planningService.getUrgencyLevel(task.dueDate) === 'urgent' ? 'bg-rose-50 text-rose-600' : 'bg-slate-50 dark:bg-slate-800 text-slate-400'\n                                     }`}>\n                                       <Calendar size={10}/> {financial.formatDate(task.dueDate)}\n                                     </div>\n                                     {task.categoryId && (\n                                       <span className=\"bg-indigo-50 dark:bg-indigo-900/30 text-indigo-500 px-2 py-1 rounded-lg text-[8px] font-black uppercase\">EAP</span>\n                                     )}\n                                  </div>\n                                </div>\n                              )}\n                            </Draggable>\n                          ))}\n                        {provided.placeholder}\n                      </div>\n                    )}\n                  </Droppable>\n                </div>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {activeSubTab === 'forecast' && (\n          <div className=\"space-y-8 animate-in fade-in\">\n             <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n                <ForecastKpi label=\"Previsão de Suprimentos\" value={forecastStats.total} icon={<Boxes size={20}/>} color=\"indigo\" sub=\"Previsão global de gastos\" />\n                <ForecastKpi label=\"Pendente de Compra\" value={forecastStats.pending} icon={<Clock size={20}/>} color=\"amber\" sub=\"Ainda não efetivado\" />\n                <ForecastKpi label=\"Efetivado/Local\" value={forecastStats.ordered + forecastStats.delivered} icon={<CheckCircle2 size={20}/>} color=\"emerald\" sub=\"Lançado no financeiro\" />\n             </div>\n\n             <div className=\"bg-white dark:bg-slate-900 p-8 rounded-[3.5rem] border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden\">\n                {/* PIPELINE NAVIGATION */}\n                <div className=\"flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-10\">\n                  <div className=\"flex flex-wrap items-center bg-slate-100 dark:bg-slate-800 p-1.5 rounded-2xl gap-1\">\n                    <ProcurementStep \n                      active={forecastStatusFilter === 'pending'} \n                      onClick={() => setForecastStatusFilter('pending')}\n                      label=\"A Comprar\"\n                      count={forecastStats.countPending}\n                      icon={<ShoppingCart size={14}/>}\n                      color=\"amber\"\n                    />\n                    <ArrowRight size={14} className=\"text-slate-300 mx-1 hidden sm:block\"/>\n                    <ProcurementStep \n                      active={forecastStatusFilter === 'ordered'} \n                      onClick={() => setForecastStatusFilter('ordered')}\n                      label=\"Pedidos de Compra\"\n                      count={forecastStats.countOrdered}\n                      icon={<Clock size={14}/>}\n                      color=\"blue\"\n                    />\n                    <ArrowRight size={14} className=\"text-slate-300 mx-1 hidden sm:block\"/>\n                    <ProcurementStep \n                      active={forecastStatusFilter === 'delivered'} \n                      onClick={() => setForecastStatusFilter('delivered')}\n                      label=\"Recebidos (Local)\"\n                      count={forecastStats.countDelivered}\n                      icon={<Truck size={14}/>}\n                      color=\"emerald\"\n                    />\n                  </div>\n\n                  <div className=\"flex flex-wrap items-center gap-3\">\n                    <div className=\"relative group\">\n                      <Search className=\"absolute left-4 top-1/2 -translate-y-1/2 text-slate-300\" size={14} />\n                      <input \n                        placeholder=\"Pesquisar...\"\n                        className=\"bg-slate-50 dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 pl-11 pr-4 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest outline-none focus:border-indigo-500 transition-all w-40\"\n                        value={forecastSearch}\n                        onChange={e => setForecastSearch(e.target.value)}\n                      />\n                    </div>\n                    {forecastStatusFilter === 'pending' && (\n                      <div className=\"flex items-center gap-2\">\n                        <button onClick={() => setIsPurchaseListOpen(true)} className=\"flex items-center gap-2 px-5 py-4 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-2xl text-[10px] font-black uppercase tracking-widest border border-slate-200 dark:border-slate-700 hover:bg-white transition-all shadow-sm\">\n                           <FileStack size={16} /> Lista de Compras\n                        </button>\n                        <button onClick={() => setIsAddingForecast(true)} className=\"flex items-center gap-2 px-6 py-4 bg-[#0f111a] text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl hover:scale-105 active:scale-95 transition-all\">\n                          <Plus size={16} /> Novo Insumo\n                        </button>\n                      </div>\n                    )}\n                  </div>\n                </div>\n                \n                <div className=\"overflow-x-auto custom-scrollbar\">\n                  <table className=\"w-full text-left border-separate border-spacing-y-3\">\n                    <thead>\n                      <tr className=\"text-[9px] font-black uppercase tracking-[0.15em] text-slate-400 text-center\">\n                        <th className=\"pb-2 w-12\"></th>\n                        <th className=\"pb-2 pl-4 text-left\">Material / Fornecedor</th>\n                        <th className=\"pb-2\">Und</th>\n                        <th className=\"pb-2\">Qtd</th>\n                        <th className=\"pb-2\">Unitário</th>\n                        <th className=\"pb-2\">Total Previsto</th>\n                        <th className=\"pb-2\">Status</th>\n                        <th className=\"pb-2\">Pago?</th>\n                        <th className=\"pb-2 text-right pr-4\">Ações</th>\n                      </tr>\n                    </thead>\n                    <Droppable droppableId=\"forecast-list\">\n                      {(provided) => (\n                        <tbody ref={provided.innerRef} {...provided.droppableProps} className=\"text-center\">\n                          {sortedForecasts.map((f, index) => {\n                            const supplier = suppliers.find(s => s.id === f.supplierId);\n                            \n                            // Lógica refinada de rótulo e valor de data baseada no status e pagamento\n                            let dateLabel = 'Previsto';\n                            let dateValue = f.estimatedDate;\n                            let dateColor = 'text-slate-400';\n                            let statusText = '';\n\n                            if (f.status === 'pending') {\n                              dateLabel = 'Previsto';\n                              dateValue = f.estimatedDate;\n                              dateColor = 'text-slate-400';\n                            } else if (f.status === 'ordered') {\n                              if (f.isPaid) {\n                                dateLabel = 'Pago';\n                                dateColor = 'text-indigo-500';\n                              } else {\n                                dateLabel = 'Comprado';\n                                dateColor = 'text-amber-500';\n                                statusText = '(A Pagar)';\n                              }\n                              dateValue = f.purchaseDate || f.estimatedDate;\n                            } else if (f.status === 'delivered') {\n                              dateLabel = 'Entregue';\n                              dateValue = f.deliveryDate || f.estimatedDate;\n                              dateColor = 'text-emerald-500';\n                            }\n\n                            return (\n                              <Draggable key={f.id} draggableId={f.id} index={index}>\n                                {(p, s) => (\n                                  <tr \n                                    ref={p.innerRef} \n                                    {...p.draggableProps} \n                                    className={`group/row bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 rounded-3xl transition-all shadow-sm ${s.isDragging ? 'shadow-2xl z-50 ring-2 ring-indigo-500 scale-[1.02]' : 'hover:shadow-md'}`}\n                                  >\n                                    <td className=\"py-6 pl-4 rounded-l-3xl\">\n                                      <div {...p.dragHandleProps} className=\"p-2 text-slate-200 hover:text-indigo-400 cursor-grab active:cursor-grabbing\">\n                                        <GripVertical size={16}/>\n                                      </div>\n                                    </td>\n                                    <td className=\"py-6 px-4 text-left min-w-[250px]\">\n                                      <div className=\"flex flex-col gap-1\">\n                                        <div className=\"flex items-center gap-2\">\n                                          <span className=\"text-sm font-black dark:text-white leading-tight uppercase\">{f.description}</span>\n                                          {f.paymentProof && (\n                                            <button onClick={() => handleViewProof(f.paymentProof!)} className=\"p-1 bg-emerald-50 text-emerald-600 rounded-md hover:bg-emerald-100 transition-colors\" title=\"Ver Comprovante\">\n                                              <ReceiptText size={10} />\n                                            </button>\n                                          )}\n                                        </div>\n                                        <div className=\"flex flex-col gap-0.5\">\n                                          <div className=\"flex items-center gap-1.5 text-[9px] font-bold text-indigo-500 uppercase tracking-widest\">\n                                            <Building2 size={10} className=\"shrink-0\" />\n                                            {supplier ? supplier.name : 'Fornecedor não vinculado'}\n                                          </div>\n                                          <div className={`flex items-center gap-1.5 text-[8px] font-black uppercase tracking-widest ${dateColor}`}>\n                                            <Calendar size={9} className=\"shrink-0\" />\n                                            {dateLabel}: {financial.formatDate(dateValue)} <span className=\"ml-1 opacity-70\">{statusText}</span>\n                                          </div>\n                                        </div>\n                                      </div>\n                                    </td>\n                                    <td className=\"py-6\">\n                                      <span className=\"text-[10px] font-black uppercase text-slate-400\">{f.unit}</span>\n                                    </td>\n                                    <td className=\"py-6\">\n                                      <input \n                                        type=\"number\"\n                                        step=\"any\"\n                                        className=\"w-16 bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-lg px-2 py-1 text-center text-[11px] font-black outline-none focus:border-indigo-500 transition-all dark:text-slate-200\"\n                                        value={f.quantityNeeded}\n                                        onBlur={(e) => onUpdatePlanning(planningService.updateForecast(planning, f.id, { quantityNeeded: parseFloat(e.target.value) || 0 }))}\n                                        onChange={(e) => {\n                                          const val = e.target.value;\n                                          onUpdatePlanning(planningService.updateForecast(planning, f.id, { quantityNeeded: parseFloat(val) || 0 }));\n                                        }}\n                                      />\n                                    </td>\n                                    <td className=\"py-6\">\n                                      <InlineCurrencyInput \n                                        value={f.unitPrice} \n                                        onUpdate={(val: number) => onUpdatePlanning(planningService.updateForecast(planning, f.id, { unitPrice: val }))} \n                                      />\n                                    </td>\n                                    <td className=\"py-6\">\n                                      <span className=\"text-sm font-black text-indigo-600 dark:text-indigo-400\">\n                                        {financial.formatVisual((f.quantityNeeded || 0) * (f.unitPrice || 0), project.theme?.currencySymbol)}\n                                      </span>\n                                    </td>\n                                    <td className=\"py-6\">\n                                      <div className=\"flex gap-2 justify-center\">\n                                        <StatusCircle active={f.status === 'pending'} onClick={() => onUpdatePlanning(planningService.updateForecast(planning, f.id, { status: 'pending' }))} icon={<AlertCircle size={12}/>} color=\"amber\" label=\"Pendente\" />\n                                        <StatusCircle active={f.status === 'ordered'} onClick={() => setConfirmingForecast(f)} icon={<ShoppingCart size={12}/>} color=\"blue\" label=\"Comprado\" />\n                                        <StatusCircle active={f.status === 'delivered'} onClick={() => onUpdatePlanning(planningService.updateForecast(planning, f.id, { status: 'delivered', deliveryDate: new Date().toISOString().split('T')[0] }))} icon={<Truck size={12}/>} color=\"emerald\" label=\"No Local\" />\n                                      </div>\n                                    </td>\n                                    <td className=\"py-6\">\n                                      <button \n                                        onClick={() => {\n                                          if (f.status === 'pending') {\n                                            setConfirmingForecast(f);\n                                          } else {\n                                            onUpdatePlanning(planningService.updateForecast(planning, f.id, { isPaid: !f.isPaid }));\n                                          }\n                                        }}\n                                        className={`p-2.5 rounded-full transition-all ${f.isPaid ? 'text-emerald-500 bg-emerald-50 dark:bg-emerald-900/30 shadow-sm' : 'text-slate-200 hover:text-rose-400 bg-slate-50 dark:bg-slate-800'}`}\n                                      >\n                                        {f.isPaid ? <CheckCircle2 size={20}/> : <Circle size={20}/>}\n                                      </button>\n                                    </td>\n                                    <td className=\"py-6 text-right pr-6 rounded-r-3xl\">\n                                      <div className=\"flex items-center justify-end gap-1 opacity-0 group-hover/row:opacity-100 transition-opacity\">\n                                        {f.status === 'pending' && (\n                                          <button \n                                            onClick={() => setConfirmingForecast(f)}\n                                            className=\"p-2 text-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/40 rounded-xl\"\n                                            title=\"Efetivar Compra\"\n                                          >\n                                            <ArrowUpRight size={18}/>\n                                          </button>\n                                        )}\n                                        {f.status === 'ordered' && (\n                                          <button \n                                            onClick={() => onUpdatePlanning(planningService.updateForecast(planning, f.id, { status: 'delivered', deliveryDate: new Date().toISOString().split('T')[0] }))}\n                                            className=\"p-2 text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/40 rounded-xl\"\n                                            title=\"Receber no Local\"\n                                          >\n                                            <Truck size={18}/>\n                                          </button>\n                                        )}\n                                        {f.paymentProof && (\n                                          <button onClick={() => handleViewProof(f.paymentProof!)} className=\"p-2 text-emerald-500 hover:bg-emerald-50 rounded-xl\" title=\"Baixar Comprovante\"><Download size={18}/></button>\n                                        )}\n                                        <button onClick={() => setEditingForecast(f)} className=\"p-2 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded-xl\" title=\"Editar\"><Edit2 size={18}/></button>\n                                        <button onClick={() => setIsDeletingForecast(f)} className=\"p-2 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-xl\" title=\"Excluir\"><Trash2 size={18}/></button>\n                                      </div>\n                                    </td>\n                                  </tr>\n                                )}\n                              </Draggable>\n                            );\n                          })}\n                          {provided.placeholder}\n                        </tbody>\n                      )}\n                    </Droppable>\n                  </table>\n                  {sortedForecasts.length === 0 && (\n                    <div className=\"py-24 flex flex-col items-center justify-center text-slate-300 opacity-40\">\n                      <Boxes size={64} className=\"mb-4\" />\n                      <p className=\"text-xs font-black uppercase tracking-[0.2em]\">Sem suprimentos neste estágio</p>\n                    </div>\n                  )}\n                </div>\n            </div>\n          </div>\n        )}\n      </DragDropContext>\n\n      {/* MODAL DE CADASTRO/EDIÇÃO DE SUPRIMENTO (DARK PREMIUM) */}\n      {(isAddingForecast || editingForecast) && (\n        <ForecastModal \n          onClose={() => { setIsAddingForecast(false); setEditingForecast(null); }}\n          allWorkItems={allWorkItems}\n          suppliers={suppliers}\n          editingItem={editingForecast}\n          onSave={(data: any) => {\n            if (editingForecast) {\n              onUpdatePlanning(planningService.updateForecast(planning, editingForecast.id, data));\n            } else {\n              onUpdatePlanning(planningService.addForecast(planning, data));\n            }\n            setIsAddingForecast(false);\n            setEditingForecast(null);\n          }}\n        />\n      )}\n\n      {isPurchaseListOpen && (\n        <PurchaseListModal \n          isOpen={isPurchaseListOpen}\n          onClose={() => setIsPurchaseListOpen(false)}\n          suppliers={suppliers}\n          onSave={handleBatchSave}\n        />\n      )}\n\n      {/* MODAL DE CONFIRMAÇÃO DE EXCLUSÃO (DARK PREMIUM) */}\n      {isDeletingForecast && (\n        <div className=\"fixed inset-0 z-[2100] flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-sm animate-in fade-in duration-300\" onClick={() => setIsDeletingForecast(null)}>\n          <div className=\"bg-[#0f111a] w-full max-w-md rounded-[3rem] p-12 shadow-2xl border border-slate-800/50 flex flex-col items-center text-center relative overflow-hidden\" onClick={e => e.stopPropagation()}>\n            <div className=\"absolute top-0 left-1/2 -translate-x-1/2 w-48 h-48 bg-rose-500/10 blur-[100px] pointer-events-none\"></div>\n            <div className=\"relative mb-10\">\n              <div className=\"w-24 h-24 bg-slate-800/40 rounded-full flex items-center justify-center border border-slate-700/50\">\n                 <Trash2 size={36} className=\"text-rose-500\" />\n              </div>\n            </div>\n            <h2 className=\"text-3xl font-black text-white uppercase tracking-tighter mb-4\">Remover Insumo?</h2>\n            <p className=\"text-slate-400 text-lg font-medium leading-relaxed mb-12\">\n              Deseja realmente excluir o suprimento <span className=\"text-white font-bold\">{isDeletingForecast.description}</span>? Esta ação é irreversível.\n            </p>\n            <div className=\"flex items-center gap-6 w-full\">\n               <button onClick={() => setIsDeletingForecast(null)} className=\"flex-1 py-4 text-slate-500 font-black uppercase text-xs tracking-widest hover:text-white transition-colors\">Voltar</button>\n               <button onClick={() => { onUpdatePlanning(planningService.deleteForecast(planning, isDeletingForecast.id)); setIsDeletingForecast(null); }} className=\"flex-[2] py-5 bg-rose-600 hover:bg-rose-50 text-white rounded-[2rem] font-black uppercase text-xs tracking-widest shadow-xl shadow-rose-500/20 active:scale-95 transition-all\">Excluir Permanente</button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {activeSubTab === 'milestones' && (\n        <div className=\"space-y-8 animate-in fade-in\">\n           <div className=\"flex items-center justify-between\">\n              <div className=\"flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl gap-1\">\n                 <button onClick={() => setMilestoneView('list')} className={`px-4 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2 ${milestoneView === 'list' ? 'bg-white dark:bg-slate-700 text-indigo-600 shadow-sm' : 'text-slate-400'}`}><List size={14}/> Lista</button>\n                 <button onClick={() => setMilestoneView('calendar')} className={`px-4 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all flex items-center gap-2 ${milestoneView === 'calendar' ? 'bg-white dark:bg-slate-700 text-indigo-600 shadow-sm' : 'text-slate-400'}`}><CalendarDays size={14}/> Calendário</button>\n              </div>\n              <button onClick={() => setIsAddingMilestone(true)} className=\"flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl shadow-indigo-500/20 hover:scale-105 active:scale-95 transition-all\">\n                <Plus size={16} /> Nova Meta\n              </button>\n           </div>\n\n           {milestoneView === 'list' ? (\n             <div className=\"bg-white dark:bg-slate-900 p-10 rounded-[3.5rem] border border-slate-200 dark:border-slate-800 shadow-sm\">\n                <div className=\"relative space-y-10 before:absolute before:left-[13px] before:top-2 before:bottom-2 before:w-1 before:bg-slate-100 dark:before:bg-slate-800\">\n                  {planning.milestones.map(m => (\n                    <div key={m.id} className=\"relative flex items-center justify-between pl-10\">\n                      <div className={`absolute left-0 w-7 h-7 rounded-full border-4 border-white dark:border-slate-900 flex items-center justify-center shadow-md ${m.isCompleted ? 'bg-emerald-500' : 'bg-slate-200 dark:bg-slate-800'}`}>\n                        <Flag size={12} className=\"text-white\" />\n                      </div>\n                      <div className={`flex-1 ml-6 bg-slate-50 dark:bg-slate-800/40 p-6 rounded-3xl border transition-all flex items-center justify-between group ${m.isCompleted ? 'border-emerald-200' : 'border-slate-100 dark:border-slate-800'}`}>\n                        <div className=\"flex flex-col gap-1\">\n                           <h4 className=\"text-base font-black dark:text-white uppercase tracking-tight\">{m.title}</h4>\n                           <p className=\"text-[11px] font-bold text-slate-400 uppercase tracking-wide flex items-center gap-2\">\n                             <Calendar size={14}/> {financial.formatDate(m.date)}\n                           </p>\n                        </div>\n                        <div className=\"flex items-center gap-4\">\n                          <button onClick={() => onUpdatePlanning(planningService.updateMilestone(planning, m.id, { isCompleted: !m.isCompleted }))} className={`text-[10px] font-black uppercase px-5 py-2 rounded-full border transition-all ${m.isCompleted ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-white dark:bg-slate-700 text-slate-400 border-slate-200 dark:border-slate-600'}`}>\n                            {m.isCompleted ? 'Finalizada' : 'Em Aberto'}\n                          </button>\n                          <button onClick={() => setEditingMilestone(m)} className=\"p-2 text-slate-300 hover:text-indigo-500 hover:bg-white rounded-lg transition-all\"><Edit2 size={18}/></button>\n                          <button onClick={() => onUpdatePlanning(planningService.deleteMilestone(planning, m.id))} className=\"p-2 text-slate-300 hover:text-rose-500 hover:bg-white rounded-lg transition-all\"><Trash2 size={18}/></button>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n             </div>\n           ) : (\n             <CalendarView milestones={planning.milestones} onEdit={setEditingMilestone} />\n           )}\n        </div>\n      )}\n\n      {/* MODAIS TAREFA E MILESTONE */}\n      {(editingTask || isAddingTask) && (\n        <TaskModal \n          task={editingTask} \n          initialStatus={isAddingTask}\n          onClose={() => { setEditingTask(null); setIsAddingTask(null); }} \n          onSave={(data: Partial<PlanningTask>) => {\n            if (editingTask) handleUpdateTask(editingTask.id, data);\n            else handleAddTask(data);\n            setEditingTask(null);\n            setIsAddingTask(null);\n          }}\n        />\n      )}\n\n      {(editingMilestone || isAddingMilestone) && (\n        <MilestoneModal \n          milestone={editingMilestone}\n          onClose={() => { setEditingMilestone(null); setIsAddingMilestone(false); }}\n          onSave={(data: Partial<Milestone>) => {\n            if (editingMilestone) onUpdatePlanning(planningService.updateMilestone(planning, editingMilestone.id, data));\n            else onUpdatePlanning(planningService.addMilestone(planning, data));\n            setEditingMilestone(null);\n            setIsAddingMilestone(false);\n          }}\n        />\n      )}\n\n      {/* MODAL DE EFETIVAR COMPRA (CORRIGIDO E DARK) */}\n      {confirmingForecast && (\n        <ConfirmForecastModal \n          forecast={confirmingForecast} \n          onClose={() => setConfirmingForecast(null)} \n          onConfirm={(isPaid: boolean, parentId: string | null, proof?: string, purchaseDate?: string) => handleFinalizePurchase(confirmingForecast, parentId, isPaid, proof, purchaseDate)}\n          financialCategories={financialCategories}\n        />\n      )}\n    </div>\n  );\n};\n\n// --- PREMIUM COMPONENTS ---\n\nconst ProcurementStep = ({ active, onClick, label, count, icon, color }: any) => {\n  const colors: any = {\n    amber: active ? 'bg-amber-500 text-white shadow-lg' : 'text-slate-400 hover:text-slate-600',\n    blue: active ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-slate-600',\n    emerald: active ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-400 hover:text-slate-600'\n  };\n\n  return (\n    <button \n      onClick={onClick}\n      className={`flex items-center gap-2 px-6 py-2.5 rounded-xl text-[9px] font-black uppercase tracking-widest transition-all ${colors[color]}`}\n    >\n      {icon}\n      <span>{label}</span>\n      <span className={`px-1.5 py-0.5 rounded-md text-[8px] font-black ${active ? 'bg-white/20' : 'bg-slate-200 dark:bg-slate-700 text-slate-500'}`}>\n        {count}\n      </span>\n    </button>\n  );\n};\n\n// --- PREMIUM FORECAST MODAL (DARK) ---\nconst ForecastModal = ({ onClose, onSave, allWorkItems, suppliers, editingItem }: any) => {\n  const [data, setData] = useState({\n    description: editingItem?.description || '',\n    quantityNeeded: editingItem?.quantityNeeded || 1,\n    unitPrice: editingItem?.unitPrice || 0,\n    unit: editingItem?.unit || 'un',\n    isPaid: editingItem?.isPaid || false,\n    estimatedDate: (editingItem?.estimatedDate || new Date().toISOString()).split('T')[0],\n    supplierId: editingItem?.supplierId || '',\n    categoryId: editingItem?.categoryId || '',\n    paymentProof: editingItem?.paymentProof || ''\n  });\n\n  return (\n    <div className=\"fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-sm animate-in fade-in duration-300\" onClick={onClose}>\n      <div className=\"bg-[#0f111a] w-full max-w-2xl rounded-[3rem] border border-slate-800/50 shadow-2xl flex flex-col overflow-hidden max-h-[95vh] relative\" onClick={e => e.stopPropagation()}>\n        <div className=\"absolute top-0 left-1/2 -translate-x-1/2 w-64 h-64 bg-indigo-500/5 blur-[120px] pointer-events-none\"></div>\n        \n        <div className=\"p-10 pb-6 shrink-0 flex items-center justify-between z-10\">\n          <div className=\"flex items-center gap-5\">\n             <div className=\"p-4 bg-slate-800/60 rounded-3xl border border-slate-700/50 text-indigo-500 shadow-xl\">\n                <Boxes size={28}/>\n             </div>\n             <div>\n               <h2 className=\"text-2xl font-black text-white uppercase tracking-tighter leading-none\">{editingItem ? 'Editar Insumo' : 'Novo Suprimento'}</h2>\n               <p className=\"text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1\">Inteligência de Aquisições</p>\n             </div>\n          </div>\n          <button onClick={onClose} className=\"p-3 text-slate-500 hover:text-white transition-all rounded-2xl hover:bg-slate-800/50\"><X size={24}/></button>\n        </div>\n\n        <div className=\"p-10 pt-0 overflow-y-auto custom-scrollbar flex-1 relative z-10 space-y-8\">\n           <div>\n              <label className=\"text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3 ml-1\">Descrição Técnica do Material</label>\n              <input \n                autoFocus \n                className=\"w-full px-8 py-5 rounded-3xl bg-slate-900 border-2 border-slate-800 text-white text-base font-black outline-none focus:border-indigo-600 transition-all placeholder:text-slate-800\" \n                value={data.description} \n                onChange={e => setData({...data, description: e.target.value})} \n                placeholder=\"Ex: Cimento Portland CP-II\" \n              />\n           </div>\n\n           <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n              <div>\n                <label className=\"text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3 ml-1\">Vínculo de Fornecedor</label>\n                <div className=\"relative\">\n                   <Building2 className=\"absolute left-5 top-1/2 -translate-y-1/2 text-slate-500\" size={18} />\n                   <select \n                    className=\"w-full pl-14 pr-10 py-5 rounded-3xl bg-slate-900 border-2 border-slate-800 text-white text-xs font-bold outline-none appearance-none focus:border-indigo-600 transition-all\" \n                    value={data.supplierId} \n                    onChange={e => setData({...data, supplierId: e.target.value})}\n                   >\n                     <option value=\"\">Não definido (Spot)</option>\n                     {suppliers.map((s: any) => <option key={s.id} value={s.id}>{s.name}</option>)}\n                   </select>\n                   <ChevronDown className=\"absolute right-5 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none\" size={16} />\n                </div>\n              </div>\n              <div>\n                <label className=\"text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3 ml-1\">Prevision de Chegada</label>\n                <div className=\"relative\">\n                   <Calendar className=\"absolute left-5 top-1/2 -translate-y-1/2 text-slate-500\" size={18} />\n                   <input \n                    type=\"date\" \n                    className=\"w-full pl-14 pr-6 py-5 rounded-3xl bg-slate-900 border-2 border-slate-800 text-white text-xs font-bold outline-none focus:border-indigo-600 transition-all [color-scheme:dark]\" \n                    value={data.estimatedDate} \n                    onChange={e => setData({...data, estimatedDate: e.target.value})} \n                   />\n                </div>\n              </div>\n           </div>\n\n           <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-6\">\n              <div>\n                <label className=\"text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3 text-center\">Unidade</label>\n                <input \n                  className=\"w-full px-4 py-5 rounded-3xl bg-slate-900 border-2 border-slate-800 text-white text-sm font-black text-center uppercase outline-none focus:border-indigo-600\" \n                  value={data.unit} \n                  onChange={e => setData({...data, unit: e.target.value})} \n                />\n              </div>\n              <div>\n                <label className=\"text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3 text-center\">Quantidade</label>\n                <input \n                  type=\"number\" \n                  className=\"w-full px-4 py-5 rounded-3xl bg-slate-900 border-2 border-slate-800 text-white text-sm font-black text-center outline-none focus:border-indigo-600\" \n                  value={data.quantityNeeded} \n                  onChange={e => setData({...data, quantityNeeded: parseFloat(e.target.value) || 0})} \n                />\n              </div>\n              <div>\n                <label className=\"text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-3 text-right\">Preço Unitário</label>\n                <div className=\"relative\">\n                  <span className=\"absolute left-5 top-1/2 -translate-y-1/2 text-[10px] font-black text-slate-600 uppercase\">R$</span>\n                  <input \n                    type=\"number\" \n                    className=\"w-full pl-12 pr-6 py-5 rounded-3xl bg-slate-900 border-2 border-slate-800 text-white text-sm font-black text-right outline-none focus:border-indigo-600\" \n                    value={data.unitPrice} \n                    onChange={e => setData({...data, unitPrice: parseFloat(e.target.value) || 0})} \n                  />\n                </div>\n              </div>\n           </div>\n\n           <div className=\"flex flex-col sm:flex-row items-center justify-between p-8 bg-slate-900/50 rounded-3xl border border-slate-800 gap-6\">\n              <div className=\"flex items-center gap-4\">\n                 <div className={`p-4 rounded-2xl ${data.isPaid ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-800 text-slate-500'} transition-colors shadow-lg`}>\n                    <CreditCard size={24}/>\n                 </div>\n                 <div>\n                    <p className=\"text-[11px] font-black text-slate-400 uppercase tracking-widest leading-none\">Estado Financeiro</p>\n                    <p className=\"text-sm font-bold text-white mt-2\">{data.isPaid ? 'Pago e Liquidado' : 'Aguardando Pagamento'}</p>\n                 </div>\n              </div>\n              <button \n                type=\"button\" \n                onClick={() => setData({...data, isPaid: !data.isPaid})}\n                className={`w-16 h-8 rounded-full relative transition-all shadow-inner ${data.isPaid ? 'bg-emerald-500' : 'bg-slate-700'}`}\n              >\n                <div className={`absolute top-1 w-6 h-6 bg-white rounded-full shadow-md transition-all ${data.isPaid ? 'left-9' : 'left-1'}`} />\n              </button>\n           </div>\n           \n           {data.paymentProof && (\n             <div className=\"p-6 bg-emerald-950/20 border border-emerald-900 rounded-3xl flex items-center justify-between\">\n                <div className=\"flex items-center gap-3 text-emerald-500\">\n                   <FileCheck size={20}/>\n                   <span className=\"text-[10px] font-black uppercase tracking-widest\">Comprovante Vinculado</span>\n                </div>\n                <button type=\"button\" onClick={() => setData({...data, paymentProof: ''})} className=\"p-2 text-rose-500 hover:bg-rose-500/10 rounded-xl transition-all\">\n                  <X size={16}/>\n                </button>\n             </div>\n           )}\n        </div>\n\n        <div className=\"p-10 pt-4 border-t border-slate-800/50 flex items-center gap-6 shrink-0 z-10 bg-[#0f111a]/80 backdrop-blur-sm\">\n           <button \n            onClick={onClose} \n            className=\"flex-1 py-5 text-slate-500 font-black uppercase text-xs tracking-widest hover:text-white transition-colors\"\n           >\n             Cancelar\n           </button>\n           <button \n            onClick={() => onSave(data)} \n            disabled={!data.description} \n            className=\"flex-[2] py-6 bg-indigo-600 hover:bg-indigo-500 text-white rounded-[2rem] font-black uppercase text-xs tracking-widest shadow-[0_15px_35px_-10px_rgba(79,70,229,0.5)] active:scale-95 transition-all flex items-center justify-center gap-3 disabled:opacity-30 disabled:cursor-not-allowed\"\n           >\n             <Save size={20} /> {editingItem ? 'Atualizar Registro' : 'Confirmar Inclusão'}\n           </button>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nconst SubTabBtn = ({ active, onClick, label, icon }: any) => (\n  <button \n    onClick={onClick} \n    className={`flex items-center gap-2 px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${\n      active ? 'bg-white dark:bg-slate-700 text-indigo-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'\n    }`}\n  >\n    {icon} <span>{label}</span>\n  </button>\n);\n\nconst ForecastKpi = ({ label, value, icon, color, sub }: any) => {\n  const colors: any = {\n    indigo: 'text-indigo-600 bg-indigo-50 dark:bg-indigo-950/40 border-indigo-100 dark:border-indigo-800',\n    amber: 'text-amber-600 bg-amber-50 dark:bg-amber-900/20 border-amber-100 dark:border-amber-800',\n    emerald: 'text-emerald-600 bg-emerald-50 dark:bg-emerald-900/20 border-emerald-100 dark:border-emerald-800'\n  };\n  return (\n    <div className=\"bg-white dark:bg-slate-900 p-6 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col justify-between\">\n      <div className=\"flex justify-between items-start mb-4\">\n        <div className={`p-2 rounded-lg ${colors[color]}`}>{icon}</div>\n        <span className=\"text-[9px] font-black uppercase tracking-widest text-slate-400\">{label}</span>\n      </div>\n      <div>\n        <p className={`text-xl font-black tracking-tighter ${colors[color].split(' ')[0]}`}>{financial.formatVisual(value, 'R$')}</p>\n        <p className=\"text-[9px] font-bold text-slate-400 uppercase mt-1\">{sub}</p>\n      </div>\n    </div>\n  );\n};\n\nconst StatusCircle = ({ active, onClick, icon, color, label }: any) => {\n  const colors: any = {\n    amber: active ? 'bg-amber-500 text-white shadow-lg shadow-amber-500/20' : 'bg-slate-100 dark:bg-slate-800 text-slate-400',\n    blue: active ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/20' : 'bg-slate-100 dark:bg-slate-800 text-slate-400',\n    emerald: active ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/20' : 'bg-slate-100 dark:bg-slate-800 text-slate-400'\n  };\n  return (\n    <div className=\"group/status relative flex justify-center\">\n      <button \n        onClick={onClick} \n        className={`p-2 rounded-full transition-all ${colors[color]}`}\n      >\n        {icon}\n      </button>\n      <span className=\"absolute bottom-full left-1/2 -translate-x-1/2 mb-3 px-3 py-1.5 bg-slate-900 text-white text-[9px] font-black uppercase rounded-lg opacity-0 group-hover/status:opacity-100 transition-all pointer-events-none whitespace-nowrap shadow-xl z-[100] transform group-hover/status:-translate-y-1\">\n        {label}\n        <div className=\"absolute top-full left-1/2 -translate-x-1/2 -mt-1 border-4 border-transparent border-t-slate-900\" />\n      </span>\n    </div>\n  );\n};\n\nconst CalendarView = ({ milestones, onEdit }: { milestones: Milestone[], onEdit: (m: Milestone) => void }) => {\n  const [currentDate, setCurrentDate] = useState(new Date());\n\n  const daysInMonth = (year: number, month: number) => new Date(year, month + 1, 0).getDate();\n  const firstDayOfMonth = (year: number, month: number) => new Date(year, month, 1).getDay();\n\n  const year = currentDate.getFullYear();\n  const month = currentDate.getMonth();\n\n  const prevMonth = () => setCurrentDate(new Date(year, month - 1, 1));\n  const nextMonth = () => setCurrentDate(new Date(year, month + 1, 1));\n\n  const monthLabel = currentDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });\n  const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];\n\n  const gridDays = useMemo(() => {\n    const totalDays = daysInMonth(year, month);\n    const startOffset = firstDayOfMonth(year, month);\n    const days = [];\n    \n    for (let i = 0; i < startOffset; i++) days.push(null);\n    \n    for (let i = 1; i <= totalDays; i++) {\n      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;\n      const dayMilestones = milestones.filter(m => m.date.startsWith(dateStr));\n      days.push({ day: i, milestones: dayMilestones, dateStr });\n    }\n    return days;\n  }, [currentDate, milestones]);\n\n  return (\n    <div className=\"bg-white dark:bg-slate-900 rounded-[3rem] border border-slate-200 dark:border-slate-800 shadow-xl overflow-hidden animate-in fade-in zoom-in-95 duration-500\">\n      <div className=\"p-8 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between bg-slate-50/50 dark:bg-slate-800/30\">\n        <h3 className=\"text-xl font-black text-slate-800 dark:text-white uppercase tracking-tight leading-none\">{monthLabel}</h3>\n        <div className=\"flex items-center gap-2\">\n          <button onClick={prevMonth} className=\"p-2 hover:bg-white dark:hover:bg-slate-700 rounded-xl transition-all shadow-sm border border-slate-200 dark:border-slate-700\"><ChevronLeft size={20}/></button>\n          <button onClick={() => setCurrentDate(new Date())} className=\"px-4 py-2 bg-white dark:bg-slate-700 text-[10px] font-black uppercase tracking-widest rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm\">Hoje</button>\n          <button onClick={nextMonth} className=\"p-2 hover:bg-white dark:hover:bg-slate-700 rounded-xl transition-all shadow-sm border border-slate-200 dark:border-slate-700\"><ChevronRight size={20}/></button>\n        </div>\n      </div>\n\n      <div className=\"p-6\">\n        <div className=\"grid grid-cols-7 gap-px bg-slate-100 dark:bg-slate-800 border border-slate-100 dark:border-slate-800 rounded-3xl overflow-hidden\">\n          {weekDays.map(d => (\n            <div key={d} className=\"bg-white dark:bg-slate-900 py-4 text-center\">\n              <span className=\"text-[10px] font-black uppercase text-slate-400 tracking-widest\">{d}</span>\n            </div>\n          ))}\n          \n          {gridDays.map((d, i) => (\n            <div key={i} className={`bg-white dark:bg-slate-900 min-h-[150px] p-3 transition-colors hover:bg-slate-50/50 dark:hover:bg-slate-800/50 ${!d ? 'opacity-30' : ''}`}>\n              {d && (\n                <div className=\"flex flex-col gap-2 h-full\">\n                  <span className={`text-[11px] font-black ${new Date().toDateString() === new Date(d.dateStr).toDateString() ? 'bg-indigo-600 text-white w-7 h-7 flex items-center justify-center rounded-lg shadow-lg' : 'text-slate-400'}`}>\n                    {d.day}\n                  </span>\n                  \n                  <div className=\"flex flex-col gap-1.5 overflow-y-auto custom-scrollbar flex-1 pr-1\">\n                    {d.milestones.map(m => (\n                      <button \n                        key={m.id}\n                        onClick={() => onEdit(m)}\n                        className={`text-[9px] font-bold p-2 rounded-lg text-left border transition-all ${\n                          m.isCompleted \n                            ? 'bg-emerald-50 text-emerald-700 border-emerald-100' \n                            : 'bg-indigo-50 text-indigo-700 border-indigo-100 hover:scale-[1.02] hover:bg-indigo-100'\n                        }`}\n                      >\n                        <div className=\"truncate\">{m.title}</div>\n                        <div className=\"text-[7px] opacity-60 uppercase mt-0.5\">{m.isCompleted ? 'Finalizado' : 'Aguardando'}</div>\n                      </button>\n                    ))}\n                  </div>\n                </div>\n              )}\n            </div>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n};\n\nconst TaskModal = ({ task, initialStatus, onClose, onSave }: any) => {\n  const [desc, setDesc] = useState(task?.description || '');\n  const [status, setStatus] = useState<TaskStatus>(task?.status || initialStatus || 'todo');\n  const [date, setDate] = useState(task?.dueDate?.split('T')[0] || new Date().toISOString().split('T')[0]);\n\n  return (\n    <div className=\"fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-md animate-in fade-in\" onClick={onClose}>\n      <div className=\"bg-white dark:bg-slate-900 w-full max-md rounded-[2.5rem] p-8 border border-slate-200 dark:border-slate-800 shadow-2xl\" onClick={e => e.stopPropagation()}>\n        <h2 className=\"text-xl font-black mb-6 dark:text-white uppercase tracking-tight\">{task ? 'Editar Tarefa' : 'Nova Tarefa'}</h2>\n        <div className=\"space-y-4\">\n          <textarea autoFocus className=\"w-full px-5 py-4 rounded-2xl border-2 border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-950 text-sm font-bold outline-none focus:border-indigo-500 transition-all\" value={desc} onChange={e => setDesc(e.target.value)} placeholder=\"O que precisa ser feito?\" />\n          <div className=\"grid grid-cols-2 gap-4\">\n            <select className=\"px-4 py-3 rounded-xl border-2 border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-950 text-xs font-bold outline-none\" value={status} onChange={e => setStatus(e.target.value as any)}>\n              <option value=\"todo\">Planejado</option>\n              <option value=\"doing\">Executando</option>\n              <option value=\"done\">Concluído</option>\n            </select>\n            <input type=\"date\" className=\"px-4 py-3 rounded-xl border-2 border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-950 text-xs font-bold outline-none\" value={date} onChange={e => setDate(e.target.value)} />\n          </div>\n        </div>\n        <div className=\"flex gap-3 mt-8\">\n           <button onClick={onClose} className=\"flex-1 py-4 text-slate-400 font-black uppercase text-[10px]\">Cancelar</button>\n           <button onClick={() => onSave({ description: desc, status, dueDate: date })} className=\"flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black uppercase text-[10px] shadow-lg active:scale-95 transition-all\">Salvar</button>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nconst MilestoneModal = ({ milestone, onClose, onSave }: any) => {\n  const [title, setTitle] = useState(milestone?.title || '');\n  const [date, setDate] = useState(milestone?.date?.split('T')[0] || new Date().toISOString().split('T')[0]);\n\n  return (\n    <div className=\"fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-md animate-in fade-in\" onClick={onClose}>\n      <div className=\"bg-white dark:bg-slate-900 w-full max-md rounded-[2.5rem] p-8 border border-slate-200 dark:border-slate-800 shadow-2xl\" onClick={e => e.stopPropagation()}>\n        <h2 className=\"text-xl font-black mb-6 dark:text-white uppercase tracking-tight\">{milestone ? 'Editar Meta' : 'Nova Meta'}</h2>\n        <div className=\"space-y-4\">\n          <input autoFocus className=\"w-full px-5 py-4 rounded-2xl border-2 border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-950 text-sm font-bold outline-none focus:border-indigo-500 transition-all\" value={title} onChange={e => setTitle(e.target.value)} placeholder=\"Título da Meta\" />\n          <input type=\"date\" className=\"w-full px-5 py-4 rounded-2xl border-2 border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-950 text-sm font-bold outline-none focus:border-indigo-500 transition-all\" value={date} onChange={e => setDate(e.target.value)} />\n        </div>\n        <div className=\"flex gap-3 mt-8\">\n           <button onClick={onClose} className=\"flex-1 py-4 text-slate-400 font-black uppercase text-[10px]\">Cancelar</button>\n           <button onClick={() => onSave({ title, date })} className=\"flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black uppercase text-[10px] shadow-lg active:scale-95 transition-all\">Salvar</button>\n        </div>\n      </div>\n    </div>\n  );\n};\n\n// --- CONFIRM PURCHASE MODAL (DARK & COMPACT) ---\nconst ConfirmForecastModal = ({ forecast, onClose, onConfirm, financialCategories }: any) => {\n  const [parentId, setParentId] = useState<string | null>(null);\n  const [purchaseDate, setPurchaseDate] = useState<string>(new Date().toISOString().split('T')[0]);\n  const [isPaid, setIsPaid] = useState(true);\n  const [paymentProof, setPaymentProof] = useState<string | undefined>(forecast.paymentProof);\n\n  return (\n    <div className=\"fixed inset-0 z-[2000] flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-sm animate-in fade-in duration-300\" onClick={onClose}>\n      <div className=\"bg-[#0f111a] w-full max-w-md rounded-[3rem] p-10 border border-slate-800/50 shadow-2xl flex flex-col items-center relative overflow-hidden text-center\" onClick={e => e.stopPropagation()}>\n        <div className=\"absolute top-0 left-1/2 -translate-x-1/2 w-48 h-48 bg-indigo-500/10 blur-[100px] pointer-events-none\"></div>\n        \n        <div className=\"relative mb-8\">\n           <div className=\"w-20 h-20 bg-slate-800/40 rounded-full flex items-center justify-center border border-slate-700/50\">\n              <Wallet size={32} className=\"text-indigo-500\" />\n           </div>\n        </div>\n\n        <h2 className=\"text-2xl font-black text-white uppercase tracking-tighter mb-4\">Efetivar Compra</h2>\n        \n        <div className=\"space-y-6 mb-8 w-full text-center\">\n           <p className=\"text-slate-400 text-base leading-relaxed\">\n             Registrar compra de <span className=\"text-white font-bold\">{forecast.description}</span> no valor de <span className=\"text-indigo-400 font-bold\">{financial.formatVisual((forecast.quantityNeeded || 0) * (forecast.unitPrice || 0), 'R$')}</span>.\n           </p>\n           \n           <div className=\"text-left space-y-6\">\n              <div className=\"grid grid-cols-1 gap-6\">\n                <div>\n                  <label className=\"text-[10px] font-black text-slate-500 uppercase mb-2 block tracking-widest ml-1\">Data da Compra</label>\n                  <div className=\"relative\">\n                    <Calendar className=\"absolute left-4 top-1/2 -translate-y-1/2 text-slate-600\" size={14} />\n                    <input \n                      type=\"date\"\n                      className=\"w-full pl-10 pr-4 py-4 rounded-2xl bg-slate-900 border-2 border-slate-800 text-white text-xs font-bold outline-none appearance-none focus:border-indigo-600 transition-all [color-scheme:dark]\"\n                      value={purchaseDate}\n                      onChange={e => setPurchaseDate(e.target.value)}\n                    />\n                  </div>\n                </div>\n\n                <div className=\"flex items-center justify-between p-4 bg-slate-900/50 rounded-2xl border border-slate-800\">\n                  <div className=\"flex items-center gap-3\">\n                    <CreditCard size={18} className={isPaid ? \"text-emerald-500\" : \"text-slate-500\"} />\n                    <span className=\"text-[10px] font-black text-white uppercase\">Marcar como Pago agora?</span>\n                  </div>\n                  <button \n                    type=\"button\" \n                    onClick={() => setIsPaid(!isPaid)}\n                    className={`w-12 h-6 rounded-full relative transition-all ${isPaid ? 'bg-emerald-500' : 'bg-slate-700'}`}\n                  >\n                    <div className={`absolute top-0.5 w-5 h-5 bg-white rounded-full shadow transition-all ${isPaid ? 'left-6.5' : 'left-0.5'}`} />\n                  </button>\n                </div>\n\n                {isPaid && (\n                  <div className=\"space-y-2 animate-in slide-in-from-top-2\">\n                    <ExpenseAttachmentZone \n                        label=\"Comprovante de Pagamento\"\n                        requiredStatus=\"PAID\"\n                        currentFile={paymentProof}\n                        onUpload={(base64) => setPaymentProof(base64)}\n                        onRemove={() => setPaymentProof(undefined)}\n                    />\n                  </div>\n                )}\n\n                <div>\n                  <label className=\"text-[10px] font-black text-slate-500 uppercase mb-2 block tracking-widest ml-1\">Vincular ao Grupo Financeiro (Opcional)</label>\n                  <div className=\"relative\">\n                    <FolderTree className=\"absolute left-4 top-1/2 -translate-y-1/2 text-slate-600\" size={14} />\n                    <select \n                      className=\"w-full pl-10 pr-4 py-4 rounded-2xl bg-slate-900 border-2 border-slate-800 text-white text-xs font-bold outline-none appearance-none focus:border-indigo-600 transition-all\" \n                      value={parentId || ''} \n                      onChange={e => setParentId(e.target.value || null)}\n                    >\n                      <option value=\"\">Sem grupo (Raiz do Financeiro)</option>\n                      {financialCategories.map((c: any) => <option key={c.id} value={c.id}>{c.description}</option>)}\n                    </select>\n                    <ChevronDown className=\"absolute right-4 top-1/2 -translate-y-1/2 text-slate-600 pointer-events-none\" size={14} />\n                  </div>\n                </div>\n              </div>\n           </div>\n        </div>\n\n        <div className=\"flex items-center gap-4 w-full\">\n           <button onClick={onClose} className=\"flex-1 py-4 text-slate-500 font-black uppercase text-xs tracking-widest hover:text-white transition-colors\">Voltar</button>\n           <button \n              onClick={() => onConfirm(isPaid, parentId, paymentProof, purchaseDate)} \n              className={`flex-[2] py-4 rounded-[1.5rem] font-black uppercase text-xs tracking-widest shadow-xl active:scale-95 transition-all ${\n                isPaid ? 'bg-emerald-600 hover:bg-emerald-500 shadow-emerald-500/20 text-white' : 'bg-indigo-600 hover:bg-indigo-500 shadow-indigo-500/20 text-white'\n              }`}\n           >\n              {isPaid ? 'Confirmar e Pagar' : 'Confirmar Pedido'}\n           </button>\n        </div>\n      </div>\n    </div>\n  );\n};\n\n// --- INLINE EDITING HELPERS ---\nconst InlineCurrencyInput = ({ value, onUpdate }: { value: number, onUpdate: (val: number) => void }) => {\n  const [localVal, setLocalVal] = useState(financial.formatVisual(value, '').trim());\n  \n  useEffect(() => {\n    setLocalVal(financial.formatVisual(value, '').trim());\n  }, [value]);\n\n  return (\n    <div className=\"flex items-center justify-center gap-1.5 px-2 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 group hover:border-indigo-400 transition-all\">\n      <span className=\"text-[9px] font-black text-slate-400\">R$</span>\n      <input \n        type=\"text\" \n        className=\"w-20 bg-transparent text-right text-[11px] font-black dark:text-slate-200 outline-none\" \n        value={localVal}\n        onChange={(e) => setLocalVal(financial.maskCurrency(e.target.value))}\n        onBlur={(e) => onUpdate(financial.parseLocaleNumber(e.target.value))}\n      />\n    </div>\n  );\n};\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1771021828,
      "nanos": 551000000
    },
    "doneTimestamp": {
      "seconds": 1771021834,
      "nanos": 762000000
    }
  },
  {
    "id": 19,
    "author": "user",
    "payload": {
      "type": "text",
      "text": "**Contexto:**\nEstou aprimorando o módulo de \"Diário de Obra\" do meu sistema de gestão. Atualmente, o diário permite relatos de texto, clima e fotos. Preciso adicionar uma camada de controle técnico baseada nas etapas da obra (EAP).\n\n**Tarefa:**\nRefatore o componente `JournalView.tsx` e atualize os tipos em `types.ts` para incluir um checklist de etapas e atribuição de responsáveis por dia.\n\n**Requisitos Funcionais:**\n\n1. **Checklist de Etapas do Dia:** No formulário de criação de diário, deve aparecer uma lista (checklist) com as etapas da obra que estão \"em andamento\". O usuário deve poder marcar \"OK\" (concluído no dia) ou \"Em andamento\".\n* *Referência:* Use os `WorkItem` associados ao projeto.\n\n\n2. **Exibição de Responsáveis:** Ao lado de cada etapa no checklist, deve ser exibido o nome do responsável técnico por aquela atividade.\n* *Lógica:* Busque o `WorkforceMember` que possua o `id` da etapa em seu campo `linkedWorkItemIds`.\n\n\n3. **Persistência do Progresso:** Ao salvar o diário, o status dessas etapas marcadas deve ser registrado no banco de dados como parte do log daquela entrada (`JournalEntry`).\n4. **Interface (UI):**\n* Use um componente de \"Accordion\" ou lista expansível para não poluir o visual.\n* Adicione ícones da `lucide-react` para status (CheckCircle, Clock, User).\n* Mantenha o estilo visual de \"cards\" com bordas arredondadas e sombras sutis.\n\n\n\n**Alterações Estruturais Necessárias:**\n\n* **`types.ts`**: Adicionar no `JournalEntry` um campo opcional `progressChecklist: { workItemId: string; status: 'done' | 'partial'; responsibleName: string }[]`.\n* **`JournalView.tsx`**: Implementar a lógica de busca de itens da EAP e seus respectivos responsáveis antes de renderizar o formulário.\n\n**Resultado Esperado:**\nO código atualizado do `JournalView.tsx` contendo a nova seção de \"Checklist de Atividades\" e a lógica de atribuição de responsáveis, garantindo que a arquiteta consiga visualizar quem responde por cada etapa listada.",
      "files": [],
      "fileUploads": [],
      "cssBlocks": [],
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1771022534,
      "nanos": 466000000
    }
  },
  {
    "id": 20,
    "author": "model",
    "payload": {
      "type": "thinking",
      "text": "**Defining Progress Controls**\n\nI'm currently focused on refactoring `JournalView.tsx`. The initial task is to incorporate a technical control layer, grounded in the project's WBS (EAP). My first step is to modify the `JournalEntry` type in `types.ts`. I'm adding an optional `progressChecklist` field. This checklist will be an array of objects.\n\n\n**Refining Item Status Tracking**\n\nI'm now determining how to track the selections in the composer form. I'm focusing on \"in progress\" work items, using their accumulated progress and contract quantity as criteria. I need to link these items to responsible staff members. My goal is to add a checklist to the JournalView form for daily marking, which then saves into the `JournalEntry`. This will inform how to display the card summary. I'm updating `JournalView.tsx` to include the logic.\n\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1771022534,
      "nanos": 466000000
    },
    "doneTimestamp": {
      "seconds": 1771022540,
      "nanos": 905000000
    }
  },
  {
    "id": 21,
    "author": "model",
    "payload": {
      "type": "text",
      "text": "Para aprimorar o **Diário de Obra** com uma camada técnica de rastreabilidade, implementaremos uma lógica de cruzamento de dados entre a **EAP (WorkItems)** e o **Quadro de Equipe (Workforce)**. Isso transformará o diário de um simples relato em uma ferramenta de controle de produtividade e responsabilidade.\n\n### Especificação Técnica das Alterações\n\n1.  **Refatoração de Modelos (`types.ts`)**:\n    *   Inclusão do tipo `JournalProgressItem` para padronizar o checklist.\n    *   Extensão da interface `JournalEntry` para suportar o histórico de progresso diário.\n\n2.  **Lógica de Atribuição no `JournalView.tsx`**:\n    *   **Filtragem Heurística**: Identificaremos itens \"Em Aberto\" (progresso < 100% e quantidade contratada > 0).\n    *   **Mapeamento de Responsáveis**: Para cada item filtrado, buscaremos no array `project.workforce` quem possui o ID correspondente, consolidando os nomes.\n\n3.  **Interface do Checklist**:\n    *   Componente de lista expansível no \"Quick Composer\".\n    *   Seletores de estado simplificados (Concluído/Parcial) com feedback visual imediato.\n    *   Visualização compacta nos cards da Timeline para consulta rápida da arquiteta.\n\n---\n\n### Implementação do Código\n\n",
      "cMarkNode": {}
    },
    "createdTimestamp": {
      "seconds": 1771022540,
      "nanos": 905000000
    },
    "doneTimestamp": {
      "seconds": 1771022541,
      "nanos": 7000000
    }
  },
  {
    "id": 22,
    "author": "model",
    "payload": {
      "type": "generationTable",
      "entries": [
        {
          "path": "types.ts",
          "generationType": 1,
          "isDone": true,
          "description": "Adição do campo progressChecklist ao JournalEntry para rastrear progresso técnico diário.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nexport type ItemType = 'category' | 'item';\n\nexport interface WorkItem {\n  id: string;\n  parentId: string | null;\n  name: string;\n  type: ItemType;\n  wbs: string;\n  order: number;\n  \n  // Especificações Técnicas\n  unit: string;\n  cod?: string;\n  fonte?: string;\n  \n  // Valores de Contrato\n  contractQuantity: number;\n  unitPrice: number; // C/ BDI\n  unitPriceNoBdi: number; // S/ BDI\n  contractTotal: number;\n\n  // Medição\n  previousQuantity: number; \n  previousTotal: number;\n  \n  currentQuantity: number; \n  currentTotal: number;\n  currentPercentage: number;\n\n  // Totais Acumulados\n  accumulatedQuantity: number;\n  accumulatedTotal: number;\n  accumulatedPercentage: number;\n  \n  // Saldo\n  balanceQuantity: number;\n  balanceTotal: number;\n\n  children?: WorkItem[];\n}\n\n// --- GESTÃO DE MÃO DE OBRA ---\nexport type WorkforceRole = 'Engenheiro' | 'Mestre' | 'Encarregado' | 'Eletricista' | 'Encanador' | 'Pedreiro' | 'Servente';\n\nexport interface StaffDocument {\n  id: string;\n  nome: string;\n  dataVencimento: string;\n  arquivoUrl?: string;\n  status: 'apto' | 'pendente' | 'vencido';\n}\n\nexport interface WorkforceMember {\n  id: string;\n  nome: string;\n  cpf_cnpj: string;\n  empresa_vinculada: string;\n  foto?: string;\n  cargo: WorkforceRole;\n  documentos: StaffDocument[];\n  linkedWorkItemIds: string[]; // Vínculo com IDs da EAP para responsabilidade técnica\n}\n\n// --- CONTRATOS DE MÃO DE OBRA ---\nexport type LaborContractType = 'empreita' | 'diaria';\nexport type LaborPaymentStatus = 'pago' | 'parcial' | 'pendente';\n\nexport interface LaborPayment {\n  id: string;\n  data: string;\n  valor: number;\n  descricao: string;\n  comprovante?: string; // Base64\n}\n\nexport interface LaborContract {\n  id: string;\n  tipo: LaborContractType;\n  descricao: string;\n  associadoId: string; // FK para WorkforceMember\n  valorTotal: number;\n  valorPago: number;\n  status: LaborPaymentStatus;\n  dataInicio: string;\n  dataFim?: string;\n  pagamentos: LaborPayment[];\n  linkedWorkItemId?: string; // FK para WorkItem\n  observacoes?: string;\n  ordem: number;\n}\n\n// --- TEMA E VISUAL ---\nexport interface PDFTheme {\n  primary: string;\n  accent: string;\n  accentText: string;\n  border: string;\n  fontFamily: 'Inter' | 'Roboto' | 'JetBrains Mono' | 'Merriweather';\n  header: { bg: string; text: string };\n  category: { bg: string; text: string };\n  footer: { bg: string; text: string };\n  kpiHighlight: { bg: string; text: string };\n  currencySymbol?: string;\n}\n\nexport const DEFAULT_THEME: PDFTheme = {\n  primary: '#1e293b',\n  accent: '#4f46e5',\n  accentText: '#ffffff',\n  border: '#e2e8f0',\n  fontFamily: 'Inter',\n  header: { bg: '#1e293b', text: '#ffffff' },\n  category: { bg: '#f8fafc', text: '#1e293b' },\n  footer: { bg: '#0f172a', text: '#ffffff' },\n  kpiHighlight: { bg: '#eff6ff', text: '#1e40af' },\n  currencySymbol: 'R$'\n};\n\n// --- MEDIÇÕES E HISTÓRICO ---\nexport interface MeasurementSnapshot {\n  measurementNumber: number;\n  date: string;\n  items: WorkItem[];\n  totals: {\n    contract: number;\n    period: number;\n    accumulated: number;\n    progress: number;\n  };\n}\n\n// --- DOCUMENTOS E ATIVOS ---\nexport interface ProjectAsset {\n  id: string;\n  name: string;\n  fileType: string;\n  fileSize: number;\n  uploadDate: string;\n  data: string;\n}\n\n// --- FINANCEIRO ---\nexport type ExpenseType = 'labor' | 'material' | 'revenue';\nexport type ExpenseStatus = 'PENDING' | 'PAID' | 'DELIVERED';\n\nexport interface ProjectExpense {\n  id: string;\n  parentId: string | null;\n  type: ExpenseType;\n  itemType: 'category' | 'item';\n  wbs: string;\n  order: number;\n  date: string;\n  description: string;\n  entityName: string;\n  unit: string;\n  quantity: number;\n  unitPrice: number;\n  amount: number;\n  isPaid: boolean;\n  status: ExpenseStatus;\n  paymentDate?: string;\n  paymentProof?: string;\n  invoiceDoc?: string;\n  deliveryDate?: string;\n  discountValue?: number;\n  discountPercentage?: number;\n  issValue?: number; // NOVO: Valor do ISS\n  issPercentage?: number; // NOVO: Alíquota do ISS\n  linkedWorkItemId?: string;\n  children?: ProjectExpense[];\n}\n\n// --- PLANEJAMENTO E CANTEIRO ---\nexport type TaskStatus = 'todo' | 'doing' | 'done';\n\nexport interface PlanningTask {\n  id: string;\n  categoryId: string | null;\n  description: string;\n  status: TaskStatus;\n  isCompleted: boolean;\n  dueDate: string;\n  createdAt: string;\n  completedAt?: string;\n}\n\nexport interface MaterialForecast {\n  id: string;\n  description: string;\n  unit: string;\n  quantityNeeded: number;\n  unitPrice: number;\n  estimatedDate: string;\n  purchaseDate?: string;\n  deliveryDate?: string;\n  status: 'pending' | 'ordered' | 'delivered';\n  isPaid: boolean;\n  order: number;\n  supplierId?: string;\n  paymentProof?: string; // NOVO: Base64 do comprovante de pagamento\n}\n\nexport interface Milestone {\n  id: string;\n  title: string;\n  date: string;\n  isCompleted: boolean;\n}\n\nexport interface ProjectPlanning {\n  tasks: PlanningTask[];\n  forecasts: MaterialForecast[];\n  milestones: Milestone[];\n  schedule?: {\n    [workItemId: string]: {\n      [period: string]: {\n        plannedPercent: number;\n      };\n    };\n  };\n}\n\n// --- DIÁRIO DE OBRA ---\nexport type JournalCategory = 'PROGRESS' | 'FINANCIAL' | 'INCIDENT' | 'WEATHER';\nexport type WeatherType = 'sunny' | 'cloudy' | 'rainy' | 'storm';\n\nexport interface JournalProgressItem {\n  workItemId: string;\n  description: string;\n  wbs: string;\n  status: 'done' | 'partial';\n  responsibleName: string;\n}\n\nexport interface JournalEntry {\n  id: string;\n  timestamp: string;\n  type: 'AUTO' | 'MANUAL';\n  category: JournalCategory;\n  title: string;\n  description: string;\n  weatherStatus?: WeatherType;\n  photoUrls: string[];\n  progressChecklist?: JournalProgressItem[]; // NOVO: Checklist técnico\n}\n\nexport interface ProjectJournal {\n  entries: JournalEntry[];\n}\n\n// --- ESTRUTURA GLOBAL ---\nexport interface ProjectGroup {\n  id: string;\n  parentId: string | null;\n  name: string;\n  order: number;\n  children?: ProjectGroup[];\n}\n\nexport interface CompanyCertificate {\n  id: string;\n  name: string;\n  issuer: string;\n  expirationDate: string;\n  status: 'valid' | 'warning' | 'expired';\n}\n\nexport interface GlobalSettings {\n  defaultCompanyName: string;\n  companyCnpj: string;\n  userName: string;\n  language: 'pt-BR' | 'en-US';\n  currencySymbol: string;\n  certificates: CompanyCertificate[];\n}\n\n// --- LICITAÇÕES ---\nexport type BiddingStatus = 'PROSPECTING' | 'DRAFTING' | 'SUBMITTED' | 'WON' | 'LOST';\n\nexport interface BiddingProcess {\n  id: string;\n  tenderNumber: string;\n  clientName: string;\n  object: string;\n  openingDate: string;\n  expirationDate: string;\n  estimatedValue: number;\n  ourProposalValue: number;\n  status: BiddingStatus;\n  items: WorkItem[];\n  assets: ProjectAsset[];\n  bdi: number;\n}\n\n// --- FORNECEDORES ---\nexport interface Supplier {\n  id: string;\n  name: string;\n  cnpj: string;\n  contactName: string;\n  email: string;\n  phone: string;\n  category: 'Material' | 'Serviço' | 'Locação' | 'Outros';\n  rating: number;\n  notes: string;\n  order: number;\n}\n\n// --- PROJETO ---\nexport interface Project {\n  id: string;\n  groupId: string | null;\n  name: string;\n  companyName: string;\n  companyCnpj: string;\n  location: string;\n  measurementNumber: number;\n  referenceDate: string;\n  logo: string | null;\n  items: WorkItem[];\n  history: MeasurementSnapshot[];\n  theme: PDFTheme;\n  bdi: number;\n  assets: ProjectAsset[];\n  expenses: ProjectExpense[];\n  workforce: WorkforceMember[];\n  laborContracts: LaborContract[]; // NOVO\n  planning: ProjectPlanning;\n  journal: ProjectJournal;\n  contractTotalOverride?: number; \n  currentTotalOverride?: number;  \n  config: {\n    strict: boolean;\n    printCards: boolean;\n    printSubtotals: boolean;\n    showSignatures: boolean;\n  };\n}\n"
            }
          ]
        },
        {
          "path": "components/JournalView.tsx",
          "generationType": 1,
          "isDone": true,
          "description": "Refatoração do Diário de Obra para incluir checklist de progresso técnico e responsáveis.",
          "diffs": [
            {
              "target": "",
              "replacement": "\nimport React, { useState, useMemo, useRef } from 'react';\nimport { Project, JournalEntry, JournalCategory, WeatherType, ProjectJournal, WorkItem, JournalProgressItem, WorkforceMember } from '../types';\nimport { journalService } from '../services/journalService';\nimport { \n  BookOpen, Plus, Camera, Sun, CloudRain, Cloud, Zap, \n  Trash2, Search, Filter, History, Loader2,\n  AlertCircle, DollarSign, BarChart, Send, X, ShieldCheck, \n  Edit3, CheckCircle2, Clock, User, ChevronDown, ListTodo, ClipboardCheck\n} from 'lucide-react';\n\ninterface JournalViewProps {\n  project: Project;\n  onUpdateJournal: (journal: ProjectJournal) => void;\n  allWorkItems: WorkItem[];\n}\n\nexport const JournalView: React.FC<JournalViewProps> = ({ project, onUpdateJournal, allWorkItems }) => {\n  const [filter, setFilter] = useState<JournalCategory | 'ALL'>('ALL');\n  const [search, setSearch] = useState('');\n  const [page, setPage] = useState(1);\n  const PAGE_SIZE = 10;\n  \n  const [isExpanded, setIsExpanded] = useState(false);\n  const [isChecklistVisible, setIsChecklistVisible] = useState(false);\n  const [newEntry, setNewEntry] = useState<Partial<JournalEntry>>({\n    title: '',\n    description: '',\n    category: 'PROGRESS',\n    weatherStatus: 'sunny',\n    photoUrls: [],\n    progressChecklist: []\n  });\n  \n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const journal = project.journal;\n\n  // Busca itens em andamento e seus responsáveis técnicos\n  const activeWorkItems = useMemo(() => {\n    return allWorkItems.filter(item => \n      item.type === 'item' && \n      (item.contractQuantity || 0) > 0 && \n      (item.accumulatedPercentage || 0) < 100\n    );\n  }, [allWorkItems]);\n\n  const getResponsibleFor = (workItemId: string): string => {\n    const member = (project.workforce || []).find(m => m.linkedWorkItemIds.includes(workItemId));\n    return member ? member.nome : 'Responsável não atribuído';\n  };\n\n  const filteredEntries = useMemo(() => {\n    return journal.entries.filter(e => {\n      const matchFilter = filter === 'ALL' || e.category === filter;\n      const matchSearch = e.title.toLowerCase().includes(search.toLowerCase()) || \n                          e.description.toLowerCase().includes(search.toLowerCase());\n      return matchFilter && matchSearch;\n    });\n  }, [journal.entries, filter, search]);\n\n  const visibleEntries = useMemo(() => {\n    return journalService.getPaginatedEntries(filteredEntries, 1, page * PAGE_SIZE);\n  }, [filteredEntries, page]);\n\n  const handlePhotoUpload = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = Array.from(e.target.files || []) as File[];\n    files.forEach(file => {\n      if (file.size > 2 * 1024 * 1024) return alert(\"Imagem muito pesada (Max 2MB)\");\n      const reader = new FileReader();\n      reader.onload = (ev) => {\n        const base64 = ev.target?.result as string;\n        setNewEntry(prev => ({ ...prev, photoUrls: [...(prev.photoUrls || []), base64] }));\n      };\n      reader.readAsDataURL(file);\n    });\n  };\n\n  const handlePost = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!newEntry.description) return;\n    \n    const entryToSave = { \n      ...newEntry, \n      title: newEntry.title || `Relatório de Obra - ${new Date().toLocaleDateString('pt-BR')}` \n    };\n\n    const updated = journalService.addEntry(journal, entryToSave);\n    onUpdateJournal(updated);\n    \n    setNewEntry({ \n      title: '', \n      description: '', \n      category: 'PROGRESS', \n      weatherStatus: 'sunny', \n      photoUrls: [],\n      progressChecklist: []\n    });\n    setIsExpanded(false);\n    setIsChecklistVisible(false);\n  };\n\n  const toggleChecklistItem = (item: WorkItem) => {\n    const current = [...(newEntry.progressChecklist || [])];\n    const index = current.findIndex(c => c.workItemId === item.id);\n\n    if (index >= 0) {\n      const existing = current[index];\n      if (existing.status === 'partial') {\n        current[index] = { ...existing, status: 'done' };\n      } else {\n        current.splice(index, 1);\n      }\n    } else {\n      current.push({\n        workItemId: item.id,\n        wbs: item.wbs,\n        description: item.name,\n        status: 'partial',\n        responsibleName: getResponsibleFor(item.id)\n      });\n    }\n    setNewEntry({ ...newEntry, progressChecklist: current });\n  };\n\n  const handleDelete = (id: string) => {\n    if (window.confirm('Deseja realmente excluir este registro do diário?')) {\n      const updated = journalService.deleteEntry(journal, id);\n      onUpdateJournal(updated);\n    }\n  };\n\n  const CategoryIcon = ({ cat }: { cat: JournalCategory }) => {\n    switch (cat) {\n      case 'PROGRESS': return <BarChart size={18} className=\"text-blue-500\" />;\n      case 'FINANCIAL': return <DollarSign size={18} className=\"text-emerald-500\" />;\n      case 'INCIDENT': return <AlertCircle size={18} className=\"text-rose-500\" />;\n      case 'WEATHER': return <Cloud size={18} className=\"text-amber-500\" />;\n    }\n  };\n\n  const WeatherIcon = ({ type }: { type: WeatherType }) => {\n    switch (type) {\n      case 'sunny': return <Sun size={14} className=\"text-amber-500\" />;\n      case 'rainy': return <CloudRain size={14} className=\"text-blue-400\" />;\n      case 'cloudy': return <Cloud size={14} className=\"text-slate-400\" />;\n      case 'storm': return <Zap size={14} className=\"text-indigo-500\" />;\n    }\n  };\n\n  return (\n    <div className=\"space-y-8 max-w-4xl mx-auto pb-20 animate-in fade-in slide-in-from-bottom-4 duration-700\">\n      \n      {/* QUICK COMPOSER */}\n      <div className=\"bg-white dark:bg-slate-900 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-xl overflow-hidden transition-all\">\n        <form onSubmit={handlePost}>\n          <div className=\"p-6\">\n            <div className=\"flex gap-4\">\n              <div className=\"w-12 h-12 rounded-2xl bg-indigo-600 flex items-center justify-center text-white shrink-0 shadow-lg shadow-indigo-500/20\">\n                <BookOpen size={24} />\n              </div>\n              <div className=\"flex-1 space-y-4\">\n                <textarea \n                  placeholder=\"Relate os fatos da obra hoje...\"\n                  className=\"w-full bg-transparent border-none text-slate-800 dark:text-slate-200 placeholder:text-slate-400 text-sm font-medium focus:ring-0 resize-none min-h-[60px]\"\n                  value={newEntry.description}\n                  onFocus={() => setIsExpanded(true)}\n                  onChange={e => setNewEntry({...newEntry, description: e.target.value})}\n                />\n                \n                {isExpanded && (\n                  <div className=\"space-y-6 animate-in fade-in slide-in-from-top-2 duration-300 pt-4 border-t border-slate-50 dark:border-slate-800\">\n                    <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                      <div className=\"space-y-1.5\">\n                        <label className=\"text-[9px] font-black uppercase text-slate-400 ml-1\">Tipo de Registro</label>\n                        <select \n                          className=\"w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-[10px] font-black uppercase tracking-widest outline-none px-4 py-3\"\n                          value={newEntry.category}\n                          onChange={e => setNewEntry({...newEntry, category: e.target.value as JournalCategory})}\n                        >\n                          <option value=\"PROGRESS\">Progresso Técnico</option>\n                          <option value=\"FINANCIAL\">Financeiro / Compras</option>\n                          <option value=\"INCIDENT\">Ocorrências / Acidentes</option>\n                          <option value=\"WEATHER\">Status Climático</option>\n                        </select>\n                      </div>\n                      \n                      <div className=\"space-y-1.5\">\n                        <label className=\"text-[9px] font-black uppercase text-slate-400 ml-1\">Clima Atual</label>\n                        <select \n                          className=\"w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl text-[10px] font-black uppercase tracking-widest outline-none px-4 py-3\"\n                          value={newEntry.weatherStatus}\n                          onChange={e => setNewEntry({...newEntry, weatherStatus: e.target.value as WeatherType})}\n                        >\n                          <option value=\"sunny\">Ensolarado</option>\n                          <option value=\"cloudy\">Nublado</option>\n                          <option value=\"rainy\">Chuvoso</option>\n                          <option value=\"storm\">Tempestade</option>\n                        </select>\n                      </div>\n                    </div>\n\n                    {/* Checklist Técnico (Expansível) */}\n                    <div className=\"space-y-3\">\n                       <button \n                         type=\"button\"\n                         onClick={() => setIsChecklistVisible(!isChecklistVisible)}\n                         className=\"flex items-center justify-between w-full p-4 bg-slate-50 dark:bg-slate-800/50 rounded-2xl hover:bg-indigo-50 dark:hover:bg-indigo-900/10 transition-colors\"\n                       >\n                         <div className=\"flex items-center gap-3\">\n                            <ListTodo size={18} className=\"text-indigo-500\" />\n                            <span className=\"text-[10px] font-black uppercase tracking-widest text-slate-600 dark:text-slate-300\">Vincular Atividades da EAP</span>\n                            {newEntry.progressChecklist && newEntry.progressChecklist.length > 0 && (\n                               <span className=\"bg-indigo-600 text-white text-[8px] font-black px-2 py-0.5 rounded-full\">\n                                 {newEntry.progressChecklist.length} ATIVIDADES\n                               </span>\n                            )}\n                         </div>\n                         <ChevronDown size={16} className={`text-slate-400 transition-transform ${isChecklistVisible ? 'rotate-180' : ''}`} />\n                       </button>\n\n                       {isChecklistVisible && (\n                         <div className=\"space-y-2 max-h-60 overflow-y-auto custom-scrollbar p-2 border-2 border-dashed border-slate-100 dark:border-slate-800 rounded-2xl\">\n                           {activeWorkItems.map(item => {\n                             const check = newEntry.progressChecklist?.find(c => c.workItemId === item.id);\n                             return (\n                               <div \n                                 key={item.id} \n                                 onClick={() => toggleChecklistItem(item)}\n                                 className={`p-4 rounded-xl border flex items-center justify-between cursor-pointer transition-all ${\n                                   check \n                                     ? (check.status === 'done' ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-amber-50 border-amber-200 text-amber-700')\n                                     : 'bg-white dark:bg-slate-900 border-slate-100 dark:border-slate-800 text-slate-500 hover:border-indigo-300'\n                                 }`}\n                               >\n                                 <div className=\"flex-1 min-w-0\">\n                                   <div className=\"flex items-center gap-2\">\n                                     <span className=\"text-[9px] font-mono opacity-50\">{item.wbs}</span>\n                                     <span className=\"text-[11px] font-black uppercase truncate\">{item.name}</span>\n                                   </div>\n                                   <div className=\"flex items-center gap-2 mt-1 opacity-70\">\n                                      <User size={10} />\n                                      <span className=\"text-[8px] font-bold uppercase tracking-wide\">Resp: {getResponsibleFor(item.id)}</span>\n                                   </div>\n                                 </div>\n                                 <div className=\"flex items-center gap-3 shrink-0\">\n                                    {check?.status === 'done' ? <CheckCircle2 size={16} /> : (check?.status === 'partial' ? <Clock size={16}/> : <div className=\"w-4 h-4 rounded-full border-2 border-slate-200\" />)}\n                                 </div>\n                               </div>\n                             );\n                           })}\n                           {activeWorkItems.length === 0 && (\n                             <p className=\"text-[10px] text-center text-slate-400 py-4 font-bold\">Nenhuma atividade em andamento no momento.</p>\n                           )}\n                         </div>\n                       )}\n                    </div>\n\n                    {/* Foto Previews */}\n                    {newEntry.photoUrls && newEntry.photoUrls.length > 0 && (\n                      <div className=\"flex flex-wrap gap-2 pt-2\">\n                        {newEntry.photoUrls.map((url, i) => (\n                          <div key={i} className=\"relative w-20 h-20 rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 group\">\n                            <img src={url} className=\"w-full h-full object-cover\" alt=\"Anexo\" />\n                            <button \n                              type=\"button\" \n                              onClick={() => setNewEntry(prev => ({ ...prev, photoUrls: prev.photoUrls?.filter((_, idx) => idx !== i) }))}\n                              className=\"absolute top-1 right-1 p-1 bg-black/50 text-white rounded-full hover:bg-rose-500 transition-colors\"\n                            >\n                              <X size={10} />\n                            </button>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n          \n          <div className=\"px-6 py-4 bg-slate-50 dark:bg-slate-800/50 border-t border-slate-100 dark:border-slate-800 flex items-center justify-between\">\n            <div className=\"flex items-center gap-2\">\n              <button \n                type=\"button\" \n                onClick={() => fileInputRef.current?.click()}\n                className=\"p-3 text-slate-400 hover:text-indigo-600 hover:bg-white dark:hover:bg-slate-700 rounded-xl transition-all\"\n                title=\"Adicionar Fotos\"\n              >\n                <Camera size={20} />\n                <input type=\"file\" ref={fileInputRef} className=\"hidden\" multiple accept=\"image/*\" onChange={handlePhotoUpload} />\n              </button>\n              <button \n                type=\"button\"\n                onClick={() => { setIsExpanded(true); setIsChecklistVisible(true); }}\n                className={`p-3 rounded-xl transition-all ${newEntry.progressChecklist?.length ? 'text-indigo-600 bg-indigo-50 dark:bg-indigo-900/30' : 'text-slate-400 hover:text-indigo-600 hover:bg-white dark:hover:bg-slate-700'}`}\n                title=\"Vincular Atividades\"\n              >\n                <ClipboardCheck size={20} />\n              </button>\n            </div>\n            \n            <div className=\"flex items-center gap-3\">\n              {isExpanded && (\n                <button type=\"button\" onClick={() => setIsExpanded(false)} className=\"text-[10px] font-black uppercase tracking-widest text-slate-400 px-4\">Cancelar</button>\n              )}\n              <button \n                type=\"submit\"\n                disabled={!newEntry.description}\n                className=\"flex items-center gap-2 px-8 py-3 bg-indigo-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-indigo-500/20 disabled:opacity-30 active:scale-95 transition-all\"\n              >\n                Registrar Diário <Send size={14} />\n              </button>\n            </div>\n          </div>\n        </form>\n      </div>\n\n      {/* FILTER & SEARCH */}\n      <div className=\"flex flex-col md:flex-row items-center justify-between gap-4\">\n        <div className=\"flex items-center gap-2 overflow-x-auto no-scrollbar w-full md:w-auto\">\n          <FilterBtn active={filter === 'ALL'} onClick={() => setFilter('ALL')} label=\"Tudo\" />\n          <FilterBtn active={filter === 'PROGRESS'} onClick={() => setFilter('PROGRESS')} label=\"Técnico\" />\n          <FilterBtn active={filter === 'FINANCIAL'} onClick={() => setFilter('FINANCIAL')} label=\"Financeiro\" />\n          <FilterBtn active={filter === 'INCIDENT'} onClick={() => setFilter('INCIDENT')} label=\"Fatos\" />\n        </div>\n        <div className=\"relative w-full md:w-64\">\n           <Search size={14} className=\"absolute left-4 top-1/2 -translate-y-1/2 text-slate-400\" />\n           <input \n             placeholder=\"Buscar no histórico...\"\n             className=\"w-full pl-10 pr-4 py-2.5 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl text-xs outline-none focus:ring-4 focus:ring-indigo-500/10 transition-all\"\n             value={search}\n             onChange={e => setSearch(e.target.value)}\n           />\n        </div>\n      </div>\n\n      {/* TIMELINE FEED */}\n      <div className=\"relative space-y-8 before:absolute before:left-[23px] before:top-4 before:bottom-4 before:w-0.5 before:bg-slate-100 dark:before:bg-slate-800\">\n        {visibleEntries.map((entry) => (\n          <div key={entry.id} className=\"relative pl-14 group\">\n            <div className={`absolute left-0 w-12 h-12 rounded-2xl border-4 border-slate-50 dark:border-slate-950 shadow-md flex items-center justify-center z-10 transition-transform group-hover:scale-110 ${\n              entry.type === 'AUTO' ? 'bg-slate-100 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'\n            }`}>\n              <CategoryIcon cat={entry.category} />\n            </div>\n\n            <div className={`bg-white dark:bg-slate-900 p-8 rounded-[2.5rem] border border-slate-100 dark:border-slate-800 shadow-sm transition-all group-hover:shadow-xl relative ${\n              entry.type === 'AUTO' ? 'border-l-4 border-l-slate-200 dark:border-l-slate-700' : ''\n            }`}>\n              <div className=\"flex flex-col md:flex-row md:items-start justify-between gap-4 mb-4\">\n                <div className=\"space-y-1\">\n                  <div className=\"flex items-center gap-3\">\n                    <h3 className=\"text-lg font-black text-slate-800 dark:text-white leading-tight\">{entry.title}</h3>\n                    {entry.type === 'AUTO' && (\n                      <span className=\"flex items-center gap-1.5 px-2 py-0.5 bg-slate-100 dark:bg-slate-800 text-slate-400 text-[8px] font-black uppercase tracking-[0.2em] rounded-full\">\n                        <ShieldCheck size={10} /> Auditoria\n                      </span>\n                    )}\n                  </div>\n                  <div className=\"flex items-center gap-3 text-[10px] font-black uppercase tracking-widest text-slate-400\">\n                    <span className=\"flex items-center gap-1.5\"><History size={12}/> {new Date(entry.timestamp).toLocaleString('pt-BR')}</span>\n                    {entry.weatherStatus && (\n                      <span className=\"flex items-center gap-1.5 border-l border-slate-200 dark:border-slate-700 pl-3\">\n                        <WeatherIcon type={entry.weatherStatus} /> {entry.weatherStatus}\n                      </span>\n                    )}\n                  </div>\n                </div>\n                \n                <div className=\"flex gap-1 opacity-0 group-hover:opacity-100 transition-all\">\n                  <button onClick={() => handleDelete(entry.id)} className=\"p-2.5 text-slate-300 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-xl transition-all\">\n                    <Trash2 size={18} />\n                  </button>\n                </div>\n              </div>\n\n              {/* Progress Summary Section */}\n              {entry.progressChecklist && entry.progressChecklist.length > 0 && (\n                <div className=\"mb-6 grid grid-cols-1 sm:grid-cols-2 gap-3\">\n                  {entry.progressChecklist.map((item, idx) => (\n                    <div key={idx} className=\"flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700\">\n                       <div className={`shrink-0 ${item.status === 'done' ? 'text-emerald-500' : 'text-amber-500'}`}>\n                         {item.status === 'done' ? <CheckCircle2 size={14}/> : <Clock size={14}/>}\n                       </div>\n                       <div className=\"min-w-0\">\n                          <p className=\"text-[10px] font-black uppercase dark:text-white truncate\">{item.description}</p>\n                          <div className=\"flex items-center gap-2 text-[8px] font-bold text-slate-400 uppercase\">\n                             <span>Resp: {item.responsibleName}</span>\n                          </div>\n                       </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n\n              <div className=\"prose prose-sm dark:prose-invert max-w-none\">\n                <p className=\"text-slate-600 dark:text-slate-300 leading-relaxed font-medium whitespace-pre-wrap\">{entry.description}</p>\n              </div>\n\n              {entry.photoUrls && entry.photoUrls.length > 0 && (\n                <div className=\"mt-6 flex flex-wrap gap-3\">\n                  {entry.photoUrls.map((url, i) => (\n                    <div key={i} className=\"w-28 h-28 rounded-2xl overflow-hidden border border-slate-100 dark:border-slate-800 shadow-sm hover:scale-105 transition-transform cursor-pointer\">\n                      <img src={url} className=\"w-full h-full object-cover\" alt=\"Evidência\" />\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n        ))}\n\n        {filteredEntries.length > visibleEntries.length && (\n          <div className=\"flex justify-center pt-8\">\n            <button \n              onClick={() => setPage(p => p + 1)}\n              className=\"px-10 py-4 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl text-[10px] font-black uppercase tracking-widest text-slate-500 hover:text-indigo-600 shadow-lg hover:shadow-indigo-500/10 transition-all flex items-center gap-2\"\n            >\n              <Loader2 size={16} className=\"animate-spin\" /> Ver Mais Registros\n            </button>\n          </div>\n        )}\n\n        {visibleEntries.length === 0 && (\n          <div className=\"py-20 flex flex-col items-center justify-center text-slate-300 opacity-40 select-none\">\n            <History size={64} className=\"mb-4\" />\n            <p className=\"text-xs font-black uppercase tracking-[0.2em]\">Sem registros no período</p>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n\nconst FilterBtn = ({ active, onClick, label }: any) => (\n  <button \n    onClick={onClick}\n    className={`px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all border ${\n      active \n        ? 'bg-indigo-600 text-white border-indigo-600 shadow-lg shadow-indigo-500/20' \n        : 'bg-white dark:bg-slate-900 text-slate-400 border-slate-200 dark:border-slate-800 hover:text-slate-600'\n    }`}\n  >\n    {label}\n  </button>\n);\n"
            }
          ]
        }
      ]
    },
    "createdTimestamp": {
      "seconds": 1771022542,
      "nanos": 661000000
    },
    "doneTimestamp": {
      "seconds": 1771022548,
      "nanos": 951000000
    }
  }
]